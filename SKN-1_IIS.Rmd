---
title: "SKN-1 dependent effects of IIS KD"
author: "Sara Irish"
date: "`r Sys.Date()`"
output: html_document
---
#Setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

suppressPackageStartupMessages({
  library(glmmTMB)
  library(car)
  library(popbio)
  library(ggplot2)
  library(ggbeeswarm)
  library(shades)
  library(RColorBrewer)
  library(DHARMa)
  library(Rmisc)
  library(dabestr)
  library(magrittr)
  library(tidyr)
  library(dplyr)
  library(ggeffects)
  library(lme4)
  library(optimx)
  library(nloptr)
  library(dfoptim)
  library(data.table)
  library(pscl)
  library(ggThemeAssist)
  library(DHARMa)
  library(emmeans)
  library(ggpubr)
  library(patchwork)
  library(lubridate)
  library(survival)
  library(coxme) #for cox model
  library(ggplot2)
  library(purrr) #for forestplot
  library(ggpubr) #for forestplot
  library(survminer) #for forestplot
  library(AICcmodavg)
  library(permutes)
  library(performance)
  library(fields)
  library(grid)
  library(ggplotify)
  library(cowplot)
  library(eha)
  library(multcomp)
  library(usethis)})#

#24-hour 15 to 25C thermocycling experiments, HF = 25C first, CF = 15C first, LS = lifespan, rep = reproduction
thermo_HF_rep <- read.csv('Thermo_H_rep.csv')
thermo_HF_LS <- read.csv('Thermo_H_LS.csv')
thermo_CF_rep <- read.csv('Thermo_C_rep.csv')
thermo_CF_LS <- read.csv('Thermo_C_LS.csv') 

#SKN-1 mutants with and without daf-2 RNAi KD in 20C - LS = lifespan, rep = reproduction
SKN_20C_rep <- read.csv('SKN1_20C_repro.csv')
SKN_20C_LS <- read.csv('SKN1_20C_LS.csv')

#Lifespan experiment SKN-1 mutants with and without daf-2 RNAi KD in 15 and 25C, with additional treatment of daf-2 RNAi KD SKN-1 mutants starting with 24 hrs of opposite temperature to test effects of temperature on early development of SKN-1 mutants
SKN_15_25_LS <- read.csv('SKN_N2_LS_15_25.csv')


```


#Cold first Thermocycling

Reproduction and lifespan assays following 24 hour thermo-cycling between 15 and 25C with 15C first across four treatments: SKN-1 mutant + daf-2 RNAi, SKN-1 mutant + ev (control), N2 + daf-2 RNAi, N2 + ev

## Reproduction 
```{r}
#Dataframe into long form
thermo_c_long <- thermo_CF_rep %>% 
  pivot_longer(
    cols = c(`D1`,`D2`, `D3`, `D4`, `D5`,`D6`, `D7`,`D8`,`D9`), 
    names_to = "Day",
    values_to = "value")

#Remove unneeded columns
thermo_c_long <- thermo_c_long %>%
  dplyr::select(c('ID','Strain', 'Treatment','Day','value'))

#Remove NAs
thermo_c_long <- na.omit(thermo_c_long)

#Combine strain and treatment into one variable for plotting
thermo_c_long <- thermo_c_long %>%
  unite(Str_tr, c('Strain', 'Treatment'), remove = F)

#Set levels of StrainxTreatment
thermo_c_long$Str_tr <- factor(thermo_c_long$Str_tr, levels = c("N2_ev", "N2_daf", "SKN-1_ev", "SKN-1_daf"))

#Create colour palette
palette <- c('#E64B35FF','#4DBBD5FF', '#00A087FF', '#3C5488FF')

#Age-specific reproduction plot
thermo_C_p <-ggplot(data=thermo_c_long, aes(x=factor(Day), y=value, group=Str_tr, color=Str_tr))+
  geom_jitter(alpha = 0.2, position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.5))+
  stat_summary(fun.data="mean_cl_boot", geom="errorbar", size = 1.2, width=0.0, position = position_dodge(0.5)) +
  stat_summary(fun.data="mean_cl_boot", geom="point", size = 3, position = position_dodge(0.5)) +
  stat_summary(fun.data="mean_cl_boot", geom="line",  size=1.2, position = position_dodge(0.5)) +
  theme_classic()+
  labs(y="Offspring number", x="")+
  labs(col="")+
  labs(title = 'Start 15\u00B0C')+   
  theme(axis.title.y = element_text(size=16))+
  theme(axis.title.x = element_text(size=16))+
  theme(axis.text= element_text(size = 14))+
  theme(legend.text = element_text(size = 14))+
  theme(plot.title = element_text(size =16))+
  scale_color_manual(values=palette)+
  theme(legend.key.width = unit(0.5,"cm"))+
  coord_cartesian(ylim = c(0,175))+
  theme(legend.position = c(0.8, 0.9))

thermo_C_p

#Make sure Day is a factor
thermo_c_long$Day <- as.factor(thermo_c_long$Day)

#Change day to a numeric variable for analysis
levels(thermo_c_long$Day) <- list('1' = 'D1', '2' = 'D2', '3' = 'D3', '4' = 'D4', '5' = 'D5', '6' = 'D6', '7' = 'D7', '8' = 'D8', '9' = 'D9')
thermo_c_long$Day <- as.numeric(thermo_c_long$Day)


#Analyse age-specific repro - use glmmTMB negative binomial due to high level of zeroes
CF_m1 <- glmmTMB(value ~ Strain *Treatment*Day + (1|ID), family = nbinom1, data = thermo_c_long)

#Simulate residuals with DHARMa package to test for dispersion and zero-inflation issues
CF_sim1 <- simulateResiduals(CF_m1, plot = T)
testDispersion(CF_sim1)#underdispersed
testZeroInflation(CF_sim1)#zero-inflation

#Add zero-inflation parameter
CF_m2 <- glmmTMB(value ~ Strain * Treatment * Day + (1|ID), ziformula = ~ Day, family = 'nbinom1', data = thermo_c_long)

#SImulate residuals again to test model
CF_sim2 <- simulateResiduals(CF_m2, plot = T)
testDispersion(CF_sim2)
testZeroInflation(CF_sim2)
summary(CF_m2)

#Get chi-squared using type III Anova to account for interaction
Anova(CF_m2, type = 'III')


# Lifetime reproduction success

#Create dataframe containing Sum of total reproduction for each individual
totalrep_CF<-na.omit(as.data.frame.table(tapply(thermo_c_long$value,list(thermo_c_long$Strain, thermo_c_long$Treatment, thermo_c_long$Str_tr, thermo_c_long$ID),sum)))

#rename columns
names(totalrep_CF)<-c('Strain', 'Treatment', "Str_tr", "Replicate", "Totrep")

#Set factor levels for 
totalrep_CF$Str_tr <- factor(totalrep_CF$Str_tr, levels = c("N2_ev", "N2_daf", "SKN-1_ev", "SKN-1_daf"))

#Create dabestr object for plotting bootstrap estimations
totrep_CF_dab <-
  totalrep_CF %>%
  load(x =Str_tr, y=Totrep,
       idx = c('N2_ev','N2_daf', 'SKN-1_ev','SKN-1_daf'))

#Get mean differences from dabestr object for plotting
totrep_CF_dab_p <- mean_diff(totrep_CF_dab)

#Create Cumming estimation plot
tot_rep_plot_CF <- dabest_plot(totrep_CF_dab_p, FALSE, raw_marker_spread = 1, swarm_label = 'LRS',custom_palette = 'npg', swarm_x_text = 12, swarm_y_text = 12, contrast_y_text = 12, contrast_x_text = 12, raw_marker_alpha = 0.3, tufte_size = 1 )

tot_rep_plot_CF

#Check distribution
hist(totalrep_CF$Totrep)#close to normal

#Analyse LRS with linear model
LRS_CF <- lm(Totrep ~ Strain * Treatment, data = totalrep_CF)

#Simulate residuals
LRS_CF_sim1 <- simulateResiduals(LRS_CF, plot = T)#looks good

summary(LRS_CF)#no effect, try removing interaction

LRS_CF2 <- lm(Totrep ~ Strain + Treatment, data = totalrep_CF)

#Simulate residuals
LRS_CF_sim2 <- simulateResiduals(LRS_CF2, plot = T)#OK

summary(LRS_CF2)#trend toward higher LRS in SKN-1

#Use type II anova to get chi-squared
Anova(LRS_CF2, type = 'II')
```


## Lifespan
```{r}

#Function for creating forest plot
meforest <- function(cox, N2_ev){ 
  require(AICcmodavg)
  require(ggplot2)
  require(forcats)
  store <- matrix(nrow = length(cox$coefficients) + 1, ncol = 4)
  ref <- c(paste(N2_ev), 0,NA, NA)
  store[1,] <- ref
  for (x in 1:length(cox$coefficients)){
    y = x+1
    mean<-cox$coefficients[x]
    emean <- (mean)
    CIL <- cox$coefficients[x] - (1.96*extractSE(cox)[x])
    CUL <- cox$coefficients[x] + (1.96*extractSE(cox)[x])
    eCIL <- (CIL)
    eCUL <- (CUL)
    store[y, 1:4] <- c(names(cox$coefficients[x]), emean, eCIL, eCUL)}
  colnames(store) <- c("Str_tr", "mean", "CIL","CUL")
  store <- as.data.frame(store)
  store$mean <- as.numeric(as.character(store$mean))
  store$CIL <- as.numeric(as.character(store$CIL))
  store$CUL <- as.numeric(as.character(store$CUL))
  forest<-ggplot(store, aes(x = mean, xmax = CUL, xmin = CIL, y = Str_tr, colour = Str_tr)) +
    geom_point(size=4, shape = 19, colour = c('#E64B35FF','#4DBBD5FF', '#00A087FF', '#3C5488FF')) +
    geom_errorbarh(height=0.25, size=0.9,  colour = c('#E64B35FF','#4DBBD5FF', '#00A087FF', '#3C5488FF')) +
    theme_minimal() +
    geom_vline(xintercept=0, linetype="dotted", size=0.8) +
    xlab("Hazard Ratio")+
    ylab("")+
    theme(
      axis.text = element_text(size = 18),
      axis.title = element_text(size = 18)
    )+
    scale_y_discrete(limits = (levels(store$Str_tr)), labels = c('Str_trSKN-1_ev' = 'SKN-1 ev', 'Str_trSKN-1_daf' = 'SKN-1 daf-2', 'Str_trN2_daf' = 'N2 daf-2', 'N2_ev' = 'N2 ev'))+
    expand_limits(x = c(-1.5,0.5))
  return(forest)
}

#Create a combined variable for strain and treatment since forest plot can't do interactions
thermo_CF_LS <- thermo_CF_LS %>%
  unite(Str_tr, c('Strain', 'Treatment.ID'), remove = F)

#Set levels
thermo_CF_LS$Tr_str <- factor(thermo_CF_LS$Str_tr, levels = c("N2_ev", "N2_daf", "SKN-1_ev", "SKN-1_daf"))

#Set as factor
thermo_CF_LS$Str_tr <- as.factor(thermo_CF_LS$Str_tr)

#Set N2_ev as baseline level
thermo_CF_LS$Str_tr <- relevel(thermo_CF_LS$Str_tr, ref = 'N2_ev')

#Exclude unnatural causes of mortality, L = loss, W = wall, E = explosion
thermo_CF_LS <- thermo_CF_LS %>%
  filter(thermo_CF_LS$Cause != 'L' & thermo_CF_LS$Cause !='W' & thermo_CF_LS$Cause != 'E')

#Create a binary variable for matricides
thermo_CF_LS$Matricide <- as.numeric(thermo_CF_LS$Cause == 'M')

CF_mat_mod <- glmer(Matricide ~ Str_tr + (1|Plate.ID), data = thermo_CF_LS, family = 'binomial')
summary(C_mat_mod)


#Create survival object for plotting Kaplan Meier curves
surv<-survfit(Surv(Age,Event)~Str_tr,data=thermo_CF_LS)

#Survival curve plot
THC_LS_plot <-ggsurvplot(surv, ylab="Survival probability\n", data = thermo_CF_LS, size= 0.8, font.ylab= 18, font.xlab= 18, legend = c(0.3, 0.4), legend.title = "", title = "Start 15\u00B0C \n Matricides uncensored", censor = FALSE, xlab = "\nDay", xlim=c(0,40), break.time.by = 5, palette = palette, position= position_dodge(0.9), legend.labs=c("N2_ev", "N2_daf", "SKN-1_ev", "SKN-1_daf"),font.tickslab = c(14),  font.legend = c(16), font.title = c(16))
THC_LS_plot


#Create dataframe excluding matricides
thermo_CF_LSNM <- thermo_CF_LS %>%
  filter(thermo_CF_LS$Cause != 'M')

#Create survival object
surv<-survfit(Surv(Age,Event)~Str_tr,data=thermo_CF_LSNM)

#Create survival curves
LS_plot_matcen_THC <-ggsurvplot(surv, ylab="Survival probability\n", data = thermo_CF_LSNM, size= 0.8, font.ylab= 18, font.xlab= 18, legend = c(0.3, 0.4), legend.title = "", palette = palette, title = "Start 15\u00B0C \n Matricides censored", censor = FALSE, xlab = "\nDay", xlim=c(0,40), break.time.by = 5, position= position_dodge(0.9), legend.labs=c("N2_ev", "N2_daf", "SKN-1_ev", "SKN-1_daf"), font.tickslab = c(14), font.legend = c(16), font.title = c(16))
LS_plot_matcen_THC

#Mixed effects cox proportional hazards model to test effect of treatment on survival probability
CF_cox <- coxme(Surv(Age, Event) ~ Str_tr + (1|Plate.ID), data = thermo_CF_LS)

#Test model 
cox.zph(CF_cox)#p< 0.0001 - need EH analysis

#Mixed effects cox proportional hazards model to test effect of treatment on survival probability
CF_NM_cox <- coxme(Surv(Age, Event) ~ Str_tr + (1|Plate.ID), data = thermo_CF_LSNM)

#Test model
cox.zph(CF_NM_cox) # p = 0.023
plot(cox.zph(CF_NM_cox))#plot looks relatively OK - will check with EH analysis

#Create forest plot from function above
CF_forest <- meforest(CF_cox, 'N2_ev')
CF_forest

#Create forest plot from function above
CF_NM_forest <- meforest(CF_NM_cox, 'N2_ev')
CF_NM_forest


```


# Hot first thermocycling

## Reproduction
```{r}
#Put dataframe into long form
thermo_h_long <- thermo_HF_rep %>% 
  pivot_longer(
    cols = c(`D1`,`D2`, `D3`, `D4`, `D5`,`D6`, `D7`,`D8`,`D9`), 
    names_to = "Day",
    values_to = "value")

#Keep only columns that are necessary
thermo_h_long <- thermo_h_long %>%
  dplyr::select(c('ID','Strain', 'Treatment','Day','value'))

#Get rid of NAs
thermo_h_long <- na.omit(thermo_h_long)

#Create a combined strain and treatment column for plotting
thermo_h_long <- thermo_h_long %>%
  unite(Str_tr, c('Strain', 'Treatment'), remove = F)

#Set factor levels for Strain x Treatment
thermo_h_long$Str_tr <- factor(thermo_h_long$Str_tr, levels = c("N2_ev", "N2_daf", "SKN-1_ev", "SKN-1_daf"))

#Age-specific reproduction plot
thermo_H_p <-ggplot(data=thermo_h_long, aes(x=factor(Day), y=value, group=Str_tr, color=Str_tr))+
  geom_jitter(alpha = 0.2, position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.5))+
  stat_summary(fun.data="mean_cl_boot", geom="errorbar", size = 1.2, width=0.0, position = position_dodge(0.5)) +
  stat_summary(fun.data="mean_cl_boot", geom="point", size = 3, position = position_dodge(0.5)) +
  stat_summary(fun.data="mean_cl_boot", geom="line",  size=1.2, position = position_dodge(0.5)) +
  theme_classic()+
  labs(y="Offspring number", x="")+
  labs(col="")+
  labs(title = 'Start 25\u00B0C')+
  theme(plot.title = element_text(size = 16))+
  theme(axis.title.y = element_text(size=16))+
  theme(axis.title.x = element_text(size=16))+
  theme(axis.text= element_text(size = 14))+
  theme(legend.text = element_text(size = 14))+
  scale_color_manual(values=palette)+
  theme(legend.key.width = unit(0.5,"cm"))+
  coord_cartesian(ylim = c(0,225))+
  theme(legend.position = c(0.8, 0.9))

thermo_H_p

#Make sure Day is a factor
thermo_h_long$Day <- as.factor(thermo_h_long$Day)

#Change day to a numeric variable for analysis
levels(thermo_h_long$Day) <- list('1' = 'D1', '2' = 'D2', '3' = 'D3', '4' = 'D4', '5' = 'D5', '6' = 'D6', '7' = 'D7', '8' = 'D8', '9' = 'D9')
thermo_h_long$Day <- as.numeric(thermo_h_long$Day)

#Analyse age-specific reproduction - glmmTMB with negative binomial family (will try nbinom2 to account for curvature at early days)

HF_m1 <- glmmTMB(value ~ Strain * Treatment * Day + (1|ID), family = nbinom2(), data = thermo_h_long)

#simulate residuals with DHARMa, test dispersion and zero inflation
HF_sim1 <- simulateResiduals(HF_m1, plot = T)
testDispersion(HF_sim1)# a bit underdispersed
testZeroInflation(HF_sim1)#very zero-inflated

#Try adding ZI paramter ~ Day (since 0's more likely to occur on certain days)
HF_m2 <- glmmTMB(value ~ Strain * Treatment * Day + (1|ID), family = nbinom2(), ziformula = ~Day, data = thermo_h_long)

#simualte residuals
HF_sim2 <- simulateResiduals(HF_m2, plot = T)
testDispersion(HF_sim2)#got a little worse
testZeroInflation(HF_sim2)#still very zero-inflated

#Try adding additional Treatment*Strain information into ZI parameter
HF_m3 <- glmmTMB(value ~ Strain * Treatment * Day + (1|ID), family = nbinom2(), ziformula = ~ Day * Strain * Treatment, data = thermo_h_long)

#simulate residuals
HF_sim3 <- simulateResiduals(HF_m3, plot= T)
testDispersion(HF_sim3)
testZeroInflation(HF_sim3)
summary(HF_m3)#not converging? all NA

#Try removing interactions from ziformula
HF_m4 <- glmmTMB(value ~ Strain * Treatment * Day + (1|ID), ziformula = ~ Day + Strain + Treatment, data = thermo_h_long, family = nbinom2())#won't converge

#Add OLRE - keep Day as formula
thermo_h_long <- tibble::rowid_to_column(thermo_h_long, "OLRE")
HF_m5 <- glmmTMB(value ~ Strain * Treatment * Day + (1|ID) + (1|OLRE), ziformula = ~ Day, family = nbinom2(), data = thermo_h_long)
summary(HF_m5)

HF_sim5 <- simulateResiduals(HF_m5, plot = T)
testDispersion(HF_sim5)
testZeroInflation(HF_sim5)

#Try including just strain in ziformula (because SKN-1s overall reproduced for longer)
HF_m6 <- glmmTMB(value ~ Strain * Treatment * Day + (1|ID) + (1|OLRE), ziformula = ~ Day + Strain, family = nbinom2(), data = thermo_h_long)
summary(HF_m6)#won't converge - previous model showed no signfiicant 3-way interaction - try removing

#Model without 3 way interaction
HF_m7 <- glmmTMB(value ~ Strain*Treatment + Strain * Day + Treatment *Day + (1|ID) + (1|OLRE), ziformula = ~Day + Strain, family = nbinom2(), data = thermo_h_long)
summary(HF_m7)#this converged

HF_sim7 <- simulateResiduals(HF_m7, plot = T)
testDispersion(HF_sim7)#better
testZeroInflation(HF_sim7)#better but still zero inflated


HF_m8 <- glmmTMB(value ~ Strain*Treatment + Strain * Day + Treatment *Day + (1|ID) + (1|OLRE), ziformula = ~1+Day + Strain, family = nbinom2(), data = thermo_h_long)
summary(HF_m8)

HF_sim8 <- simulateResiduals(HF_m8, plot = T)
testDispersion(HF_sim8)#better
testZeroInflation(HF_sim8)#slightly better


HF_m9 <- glmmTMB(value ~ Strain*Treatment + Strain * Day + Treatment *Day + (1|ID) + (1|OLRE), ziformula = ~1+Day * Strain, family = nbinom2(), data = thermo_h_long)
summary(HF_m9)#won't converge

HF_m10 <- glmmTMB(value ~ Strain*Treatment + Strain * Day + Treatment *Day + (1|ID) + (1|OLRE), ziformula = ~1+Day + Strain, family = nbinom1(), data = thermo_h_long)
summary(HF_m10)#doesn't converge


#Try using splines
library(splines)
HF_m11 <- glmmTMB(value ~ Strain*Treatment + Strain*Day + Treatment*Day + (1|ID), ziformula =~ ns(Day, df = 3), family = nbinom2(), data = thermo_h_long)
summary(HF_m11)
HF_sim11 <- simulateResiduals(HF_m11, plot = T)
testDispersion(HF_sim11)
testZeroInflation(HF_sim11)

HF_m11_2 <- glmmTMB(value ~ Strain*Treatment + Strain*Day + Treatment*Day + (1|ID), ziformula =~ ns(Day, df = 2), family = nbinom2(), data = thermo_h_long)

HF_m11_4 <- glmmTMB(value ~ Strain*Treatment + Strain*Day + Treatment*Day + (1|ID), ziformula =~ ns(Day, df = 4), family = nbinom2(), data = thermo_h_long)

AIC(HF_m11, HF_m11_2, HF_m11_4)
#Calculate total reproduction over experiment per individual
totalrep_HF<-na.omit(as.data.frame.table(tapply(thermo_h_long$value,list(thermo_h_long$Strain, thermo_h_long$Treatment, thermo_h_long$Str_tr, thermo_h_long$ID),sum)))

library(ggeffects)

# predictions for Strain x Day, group by Treatment
preds <- ggpredict(HF_m11, terms = c("Day", "Strain", "Treatment"))
plot(preds)

# try grouping by strain
preds2 <- ggpredict(HF_m11, terms = c("Day", "Treatment", "Strain"))
plot(preds2)


#rename columns
names(totalrep_HF)<-c('Strain','Treatment',"Str_tr", "Replicate", "Totrep")

#change factor levels
totalrep_HF$Str_tr <- factor(totalrep_HF$Str_tr, levels = c("N2_ev", "N2_daf", "SKN-1_ev", "SKN-1_daf"))

#Create dabestr object for Cumming estimation plot
totrep_HF_dab <-
  totalrep_HF %>%
  load(x =Str_tr, y=Totrep,
       idx = c('N2_ev','N2_daf', 'SKN-1_ev','SKN-1_daf'))

#Get mean differences for estimation plot
totrep_HF_p <- mean_diff(totrep_HF_dab)

#Create bootstrap estimation plot
tot_rep_plot_HF <- dabest_plot(totrep_HF_p, FALSE, raw_marker_spread = 1, swarm_label = 'LRS',custom_palette = 'npg', swarm_x_text = 12, swarm_y_text = 12, contrast_y_text = 12, contrast_x_text = 12, raw_marker_alpha = 0.3, tufte_size = 1 )

tot_rep_plot_HF


#Check distribution of LRS 
hist(totalrep_HF$Totrep)#normal

#Linear model to analyse total repro
LRS_HF_m1 <- lm(Totrep ~ Treatment*Strain, data = totalrep_HF)
summary(LRS_HF_m1)

#simulate residual with DHARMa package
LRS_HF_sim1 <- simulateResiduals(LRS_HF_m1, plot = T)#OK!

#Try removing interaction
LRS_HF_m2 <- lm(Totrep ~ Treatment + Strain, data = totalrep_HF)
summary(LRS_HF_m2)#SKN-1 have (significantly) lower LRS now in hot first

#simulate residuals
LRS_HF_sim2 <- simulateResiduals(LRS_HF_m2, plot = T)#OK!

```

## Lifespan
```{r}


thermo_HF_LS <- thermo_HF_LS %>%
  unite(Str_tr, c('Strain', 'Treatment.ID'), remove = F)

thermo_HF_LS$Str_tr <- as.factor(thermo_HF_LS$Str_tr)

thermo_HF_LS$Str_tr <- relevel(thermo_HF_LS$Str_tr, ref = 'N2_ev')

thermo_HF_LS <- thermo_HF_LS %>%
  filter(thermo_HF_LS$Cause != 'L' & thermo_HF_LS$Cause !='W' & thermo_HF_LS$Cause != 'E')

thermo_HF_LS$Str_tr <- factor(thermo_HF_LS$Str_tr, levels = c("N2_ev", "N2_daf", "SKN-1_ev", "SKN-1_daf"))

class(thermo_HF_LS$Age)

thermo_HF_LS$Age <- as.numeric(thermo_HF_LS$Age)

surv<-survfit(Surv(Age,Event)~Str_tr,data=thermo_HF_LS)

thermo_HF_LS$Matricide <- as.numeric(thermo_HF_LS$Cause == 'M')

mat_mod <- glmer(Matricide ~ Str_tr + (1|Plate.ID), data = thermo_HF_LS, family = 'binomial')
summary(mat_mod)

palette <- c('#E64B35FF','#4DBBD5FF', '#00A087FF', '#3C5488FF')

THH_LS_plot <-ggsurvplot(surv, ylab="Survival probability\n", data = thermo_HF_LS, size= 0.8, font.ylab= 18, font.xlab= 18, legend = c(0.8, 0.9), legend.title = "", title = "Start 25\u00B0C \n Matricides uncensored", censor = FALSE, xlab = "\nDay", xlim=c(0,40), break.time.by = 5, palette = palette, position= position_dodge(0.9), legend.labs=c("N2_ev", "N2_daf", "SKN-1_ev", "SKN-1_daf"),font.tickslab = c(14),  font.legend = c(16), font.title = c(16))
THH_LS_plot

thermo_HF_LSNM <- thermo_HF_LS %>%
  filter(thermo_HF_LS$Cause != 'M')

surv<-survfit(Surv(Age,Event)~Str_tr,data=thermo_HF_LSNM)

LS_plot_matcen_THH <-ggsurvplot(surv, ylab="Survival probability\n", data = thermo_HF_LSNM, size= 0.8, font.ylab= 18, font.xlab= 18, legend = c(0.2, 0.2), legend.title = "", palette = palette, title = "Start 25\u00B0C \n Matricides censored", censor = FALSE, xlab = "\nDay", xlim=c(0,40), break.time.by = 5, position= position_dodge(0.9), legend.labs=c("N2_ev", "N2_daf", "SKN-1_ev", "SKN-1_daf"), font.tickslab = c(14), font.legend = c(16), font.title = c(16))
LS_plot_matcen_THH


THH_cox <- coxme(Surv(Age, Event) ~ Str_tr + (1|Plate.ID), data = thermo_HF_LS)
cox.zph(THH_cox)

THH_NM_cox <- coxme(Surv(Age, Event) ~ Str_tr + (1|Plate.ID), data = thermo_HF_LSNM)


THH_forest <- meforest(THH_cox, 'N2_ev')
THH_forest

THH_NM_forest <- meforest(THH_NM_cox, 'N2_ev')
THH_NM_forest


THH_all_plot <- ggarrange(THH_LS_plot$plot, LS_plot_matcen_THH$plot, THH_forest, THH_NM_forest, common.legend = T, nrow = 2, ncol = 2,heights = c(2, 1), labels = c('A', 'B'))
THH_all_plot

```


#SKN-1 in 20C
Reproduction and lifespan assays in SKN-1 mutants with daf-2 or ev (control) RNAi treatments in 20C

##Reproduction
```{r}
#put data into long form
skn_long <- SKN_20C_rep %>% 
  pivot_longer(
    cols = c(`D1`, `D2`, `D3`, `D4`, `D5`), 
    names_to = "Day",
    values_to = "value")

#select only columns needed
skn_long <- skn_long %>%
  dplyr::select(c('ID','Treatment','Day','value'))

#get rid of NAs
skn_long <- na.omit(skn_long)

#age-specific reproduction plot for SKN-1 mutants with daf or ev
skn_20C_p <-ggplot(data=skn_long, aes(x=factor(Day), y=value, group=Treatment, color=Treatment))+
  geom_jitter(alpha = 0.2, position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.5))+
  stat_summary(fun.data="mean_cl_boot", geom="errorbar", size = 1.2, width=0.0, position = position_dodge(0.5)) +
  stat_summary(fun.data="mean_cl_boot", geom="point", size = 3, position = position_dodge(0.5)) +
  stat_summary(fun.data="mean_cl_boot", geom="line",  size=1.2, position = position_dodge(0.5)) +
  theme_classic()+
  labs(y="Offspring number", x="")+
  labs(col="")+
  theme(axis.title.y = element_text(size=20))+
  theme(axis.title.x = element_text(size=20))+
  theme(axis.text= element_text(size = 18))+
  theme(legend.text = element_text(size = 18))+
  scale_color_manual(values=c('#4DBBD5FF','#E64B35FF'))+
  theme(legend.key.width = unit(0.5,"cm"))+
  coord_cartesian(ylim = c(0,225))+
  theme(legend.position = c(0.1, 0.9))

skn_20C_p


#sum up total number of offspring produced over experiment per individual
totalrep_SKN<-na.omit(as.data.frame.table(tapply(skn_long$value,list(skn_long$Treatment, skn_long$ID),sum)))

#rename columns
names(totalrep_SKN)<-c("Treatment", "Replicate", "Totrep")

#rename factor levels of treatment
totalrep_SKN$Treatment <- revalue(totalrep_SKN$Treatment, c('ev' = 'ev', 'daf' = 'daf-2'))

#create dabestr object for plotting cumming estimation
totrep_SKN_dab <-
  totalrep_SKN %>%
  load(x =Treatment, y=Totrep,
       idx = c('ev','daf-2'))

#get mean differences for plot
totrep_SKN_p <- mean_diff(totrep_SKN_dab)

#cumming estimation plot for LRS in SKN-1 at 20C with daf or ev
tot_rep_SKN_plot <- dabest_plot(totrep_SKN_p, FALSE, raw_marker_spread = 1, swarm_label = 'LRS',custom_palette = 'npg', swarm_x_text = 16, swarm_y_text = 14, contrast_y_text = 16, contrast_x_text = 14, raw_marker_alpha = 0.3, tufte_size = 1 )
tot_rep_SKN_plot

#combined age-specific repro plot and LRS
skn_20C_rep <- ggarrange(skn_20C_p, tot_rep_plot+theme(plot.margin = unit(c(40,30,30,10), 'pt')), ncol = 2, widths = c(2, 1), labels = c('A','B'))
skn_20C_rep

#Look at distribution
  hist(totalrep_SKN$Totrep)#pretty skewed - but try LM

#Try running basic linear model
SKN_LRS_m1 <- lm(value ~ Treatment, data = skn_long)
summary(SKN_LRS_m1)
SKN_LRS_sim1 <- simulateResiduals(SKN_LRS_m1, plot = T)

#Try a Gamma GLM
SKN_LRS_m2 <- glm(Totrep ~ Treatment, data = totalrep_SKN, family = Gamma(link = 'log'))
summary(SKN_LRS_m2)
SKN_LRS_sim2 <- simulateResiduals(SKN_LRS_m2, plot = T)

#Try link = identity
SKN_LRS_m3 <- glm(Totrep ~ Treatment, data = totalrep_SKN, family = Gamma(link = 'inverse'))
summary(SKN_LRS_m3)
SKN_LRS_sim3 <- simulateResiduals(SKN_LRS_m3, plot = T)

# Reflect so the skew becomes positive
max_val <- max(totalrep_SKN$Totrep)
totalrep_SKN$Totrep_reflected <- log(max_val + 1 - totalrep_SKN$Totrep)

SKN_LRS_m4 <- lm(Totrep_reflected ~ Treatment, data = totalrep_SKN)
summary(SKN_LRS_m4)

totalrep_SKN$Treatment <- as.factor(totalrep_SKN$Treatment)
new_data2 <- data.frame(Treatment = levels(totalrep_SKN$Treatment))

# Predict on response scale (i.e., expected Totrep, not log)
pred <- predict(SKN_LRS_m2, newdata = new_data2, type = "response", se.fit = TRUE)

# Add predictions to data frame
new_data2$fit <- pred$fit
new_data2$se <- pred$se.fit
new_data2$lower <- new_data2$fit - 1.96 * new_data2$se
new_data2$upper <- new_data2$fit + 1.96 * new_data2$se

ggplot(new_data2, aes(x = Treatment, y = fit)) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2) +
  labs(y = "Predicted LRS", 
       title = "Gamma GLM predictions") +
  theme_minimal()
#predictions look right, stick with Gamma model

```

##Lifespan
```{r}

#Create forest plot function
meforest <- function(cox, ev){
  require(AICcmodavg)
  require(ggplot2)
  require(forcats)
  store <- matrix(nrow = length(cox$coefficients) + 1, ncol = 4)
  ref <- c(paste(ev), 0,NA, NA)
  store[1,] <- ref
  for (x in 1:length(cox$coefficients)){
    y = x+1
    mean<-cox$coefficients[x]
    emean <- (mean)
    CIL <- cox$coefficients[x] - (1.96*extractSE(cox)[x])
    CUL <- cox$coefficients[x] + (1.96*extractSE(cox)[x])
    eCIL <- (CIL)
    eCUL <- (CUL)
    store[y, 1:4] <- c(names(cox$coefficients[x]), emean, eCIL, eCUL)}
  colnames(store) <- c("Treatment", "mean", "CIL","CUL")
  store <- as.data.frame(store)
  store$mean <- as.numeric(as.character(store$mean))
  store$CIL <- as.numeric(as.character(store$CIL))
  store$CUL <- as.numeric(as.character(store$CUL))
  forest<-ggplot(store, aes(x = mean, xmax = CUL, xmin = CIL, y = Treatment, colour = Treatment)) +
    geom_point(size=4, shape = 19, colour = c('#E64B35FF','#4DBBD5FF')) +
    geom_errorbarh(height=0.25, size=0.9,  colour = c('#E64B35FF','#4DBBD5FF')) +
    theme_minimal() +
    geom_vline(xintercept=0, linetype="dotted", size=0.8) +
    xlab("Hazard Ratio")+
    ylab("")+
    theme(
      axis.text = element_text(size = 16),
      axis.title = element_text(size = 18)
    )+
    scale_y_discrete(limits = (levels(store$Treatment)), labels = c('Treatment.IDdaf-2'='daf-2', 'ev' = 'ev'))+
    expand_limits(x = c(-0.75,0.75))
  return(forest)
}

#Get rid of NAs
SKN_20C_LS <- na.omit(SKN_20C_LS)

#Rename daf to daf-2
SKN_20C_LS$Treatment.ID <- revalue(SKN_20C_LS$Treatment.ID, c('ev' = 'ev', 'daf' = 'daf-2'))

#Make sure Treatment is a factor
SKN_20C_LS$Treatment.ID <- as.factor(SKN_20C_LS$Treatment.ID)

#Make ev the baseline level
SKN_20C_LS$Treatment.ID <- relevel(SKN_20C_LS$Treatment.ID, ref = 'ev')

#Check factor levels of treatment
levels(SKN_20C_LS$Treatment.ID)

#Get rid of empty levels
SKN_20C_LS$Treatment.ID <- droplevels(SKN_20C_LS$Treatment.ID)

#Plate.ID as a factor not a numerical
SKN_20C_LS$Plate.ID <- as.factor(SKN_20C_LS$Plate.ID)

#Create survival object for SKN-1 mutants at 20C
surv<-survfit(Surv(Age,Event)~Treatment.ID,data=SKN_20C_LS)

#Create survival curve from survival object
SKN_20C_LS_plot <-ggsurvplot(surv, ylab="Survival probability\n", data = SKN_20C_LS, size= 0.8, font.ylab= 18, font.xlab= 18, palette=c('#E64B35FF','#4DBBD5FF'), legend = c(0.8, 0.8), legend.title = "", legend.labs = c('ev','daf-2'), title = "", censor = FALSE, xlab = "\nDay", xlim=c(0,35), break.time.by = 5, position= position_dodge(0.9), font.tickslab = c(14), font.legend = c(16))

SKN_20C_LS_plot

#Mixed effects cox model for a effect of daf-2 on SKN-1 mutant lifespan
cox_SKN_20C <- coxme(Surv(Age, Event) ~ Treatment.ID + (1|Plate.ID), data = SKN_20C_LS)

#test model
cox.zph(cox_SKN_20C)#OK
summary(cox_SKN_20C)

#Use forest plot function with cox results
SKN_forest <-meforest(cox_SKN_20C, "ev")
SKN_forest

#Exclude matricides
SKN_20C_LS_NM <- SKN_20C_LS %>%
  filter(Cause != 'M')

#Create survival object
surv<-survfit(Surv(Age,Event)~Treatment.ID,data=SKN_20C_LS_NM)

#Survival plot
SKN_NM_LS_plot <-ggsurvplot(surv, ylab="Survival probability\n", data = SKN_20C_LS_NM, size= 0.8, font.ylab= 18, font.xlab= 18, palette=c('#E64B35FF','#4DBBD5FF'), legend = c(0.8, 0.8), legend.title = "", legend.labs = c('ev','daf-2'), title = "", censor = FALSE, xlab = "\nDay", xlim=c(0,35), break.time.by = 5, position= position_dodge(0.9), font.tickslab = c(14), font.legend = c(16))

SKN_NM_LS_plot

#Cox mixed effects model
cox_SKN_20C_NM <- coxme(Surv(Age, Event) ~ Treatment.ID + (1|Plate.ID), data = SKN_20C_LS_NM)
summary(cox_SKN_20C_NM)

#Test model
cox.zph(cox_SKN_20C_NM)#OK

#Create forest plot
SKN_NM_forest <-meforest(cox_SKN_20C_NM, "ev")
SKN_NM_forest

#Combine all survival and forest plots for 20C SKN-1 mutants
SKN_LS_all_plot <- ggarrange(SKN_20C_LS_plot$plot, SKN_NM_LS_plot$plot, SKN_forest, SKN_NM_forest, common.legend = T, nrow = 2, ncol = 2,heights = c(2, 1), labels = c('A', 'B'))

SKN_LS_all_plot

```

# SKN-1 in 25C
Reproduction and lifespan assays in SKN-1 mutants and N2s with daf-2 or ev (control) RNAi treatments in 25C, including a treatment with a single 24-hour cycle of 15C at ~ L2 stage
## Lifespan
```{r}

#Temperature as a factor
SKN_15_25_LS$Temperature <- as.factor(SKN_15_25_LS$Temperature)

#Get only 25C data
SKN_25 <- SKN_15_25_LS %>%
  filter(Temperature != '15' & Temperature != '15F')

#Combine Strain and treatment for plotting
SKN_25 <- SKN_25 %>%
  unite(Str_tr, 'Strain','Treatment.ID', remove = F)

#Also combine temperature with strain and treatment
SKN_25 <- SKN_25 %>%
  unite(Str_tr_temp, 'Str_tr', 'Temperature', remove = F)

#Rename factor levels
SKN_25$Str_tr_temp <- factor(SKN_25$Str_tr_temp, levels = c('N2_ev_25','N2_daf_25','SKN_ev_25','SKN_daf_25','SKN_daf_25F'))

#Ensure it's a factor
SKN_25$Str_tr_temp <- as.factor(SKN_25$Str_tr_temp)

#Set ev N2 with 25C only as reference level
SKN_25$Str_tr_temp <- relevel(SKN_25$Str_tr_temp, ref = 'N2_ev_25')

#Create survival object for plot
surv_SKN25<-survfit(Surv(Age,Event)~Str_tr + Temperature,data=SKN_25)

#Create survival curve
SKN_25_plot <-ggsurvplot(surv_SKN25, ylab="Survival probability\n", data = SKN_25, size= 0.8, font.ylab= 18, font.xlab= 18, legend = c(0.8, 0.8), legend.title = "", title = "", palette = c('#4DBBD5FF','#E64B35FF' ,'#3C5488FF','#F39B7FFF','#00A087FF'),censor = FALSE, xlab = "\nDay", xlim=c(0,30), break.time.by = 5, position= position_dodge(0.9), font.tickslab = c(14), font.legend = c(16))

SKN_25_plot

#Exclude matricides
SKN_25_NM <- SKN_25 %>%
  filter(Cause != 'M')

#Create survival object
surv_SKN25_NM<-survfit(Surv(Age,Event)~Str_tr + Temperature,data=SKN_25_NM)

#Create survival curve
SKN_25_NM_plot <-ggsurvplot(surv_SKN25_NM, ylab="Survival probability\n", data = SKN_25_NM, size= 0.8, font.ylab= 18, font.xlab= 18, legend = c(0.8, 0.8), legend.title = "", title = "", palette = c('#4DBBD5FF','#E64B35FF' ,'#3C5488FF','#F39B7FFF','#00A087FF'), censor = FALSE, xlab = "\nDay", xlim=c(0,30), break.time.by = 5, position= position_dodge(0.9), font.tickslab = c(14), font.legend = c(16))

SKN_25_NM_plot

#Also try excluding explosions - see if it effects results
SKN_25_NMNE <- SKN_25 %>%
  filter(Cause != 'E' & Cause != 'M')

#Create survival object
surv_SKN25_NMNE<-survfit(Surv(Age,Event)~Str_tr + Temperature,data=SKN_25_NMNE)

#Create survival curves
SKN_25_NMNE_plot <-ggsurvplot(surv_SKN25_NMNE, ylab="Survival probability\n", data = SKN_25_NMNE, size= 0.8, font.ylab= 18, font.xlab= 18, legend = c(0.8, 0.8), legend.title = "", title = "", censor = FALSE, xlab = "\nDay", xlim=c(0,30), break.time.by = 5, palette = c('#4DBBD5FF','#E64B35FF' ,'#3C5488FF','#F39B7FFF','#00A087FF'), position= position_dodge(0.9), font.tickslab = c(14), font.legend = c(16))

SKN_25_NMNE_plot

#Make sure Str-tr_temp is a factor
SKN_25_NM$Str_tr_temp <- as.factor(SKN_25_NM$Str_tr_temp)

#Reset baseline to ev N2 in 25 only
SKN_25_NM$Str_tr_temp <- relevel(SKN_25_NM$Str_tr_temp, ref = 'N2_ev_25')

#Forest plot function
meforest <- function(cox, N2_ev_25){  
  require(AICcmodavg)
  require(ggplot2)
  require(forcats)
  store <- matrix(nrow = length(cox$coefficients) + 1, ncol = 4)
  ref <- c(paste(N2_ev_25), 0,NA, NA)
  store[1,] <- ref
  for (x in 1:length(cox$coefficients)){
    y = x+1
    mean<-cox$coefficients[x]
    emean <- (mean)
    CIL <- cox$coefficients[x] - (1.96*extractSE(cox)[x])
    CUL <- cox$coefficients[x] + (1.96*extractSE(cox)[x])
    eCIL <- (CIL)
    eCUL <- (CUL)
    store[y, 1:4] <- c(names(cox$coefficients[x]), emean, eCIL, eCUL)}
  colnames(store) <- c("Str_tr_temp", "mean", "CIL","CUL")
  store <- as.data.frame(store)
  store$mean <- as.numeric(as.character(store$mean))
  store$CIL <- as.numeric(as.character(store$CIL))
  store$CUL <- as.numeric(as.character(store$CUL))
  forest<-ggplot(store, aes(x = mean, xmax = CUL, xmin = CIL, y = Str_tr_temp, colour = Str_tr_temp)) +
    geom_point(size=4, shape = 19, colour = c('#E64B35FF','#4DBBD5FF','#00A087FF', '#3C5488FF','#F39B7FFF')) +
    geom_errorbarh(height=0.25, size=0.9,  colour = c('#E64B35FF','#4DBBD5FF','#00A087FF', '#3C5488FF','#F39B7FFF')) +
    theme_minimal() +
    geom_vline(xintercept=0, linetype="dotted", size=0.8) +
    xlab("Hazard Ratio")+
    ylab("")+
    theme(
      axis.text = element_text(size = 16),
      axis.title = element_text(size = 18)
    )+
    scale_y_discrete(limits = (levels(store$Str_tr_temp)), labels = c('N2_ev_25' = 'N2 ev', 'Str_tr_tempN2_daf_25' = 'N2 daf-2', 'Str_tr_tempSKN_ev_25' = 'SKN-1 ev', 'Str_tr_tempSKN_daf_25' = 'SKN-1 daf-2', 'Str_tr_tempSKN_daf_25F' = 'SKN-1 daf-2 15C \n~ L2-L3'))+
    expand_limits(x = c(-0.75,0.75))
  return(forest)
}

#Cox mixed effects model
cox_SKN_25_NM <- coxme(Surv(Age, Event) ~ Str_tr_temp + (1|Plate.ID), data = SKN_25_NM)

#test model with plot too
cox.zph(cox_SKN_25_NM)#OK - but only just acceptable
plot(cox.zph(cox_SKN_25_NM))

#create forest plot
SKN_25_NM_forest <- meforest(cox_SKN_25_NM, 'N2_ev_25')

SKN_25_NM_forest

#Including matricides
cox_SKN_25 <- coxme(Surv(Age, Event) ~ Str_tr_temp + (1|Plate.ID), data = SKN_25)
#test model
cox.zph(cox_SKN_25)#not OK

#Forest plot
SKN_25_forest <- meforest(cox_SKN_25, 'N2_ev_25')

SKN_25_allplot <- ggarrange(SKN_25_NM_plot$plot, SKN_25_NM_forest, nrow = 2, heights = c(1.5, 1))

SKN_25_allplot
```

SKN 15 C
```{r}

#Include only 15C data
SKN_15 <- SKN_15_25_LS %>%
  filter(Temperature != '25' & Temperature != '25F')

#Unite strain and treatment for plotting
SKN_15 <- SKN_15 %>%
  unite(Str_tr, 'Strain','Treatment.ID', remove = F)

#Unite strain, treatment and temperature for plotting
SKN_15 <- SKN_15 %>%
  unite(Str_tr_temp, 'Str_tr', 'Temperature', remove = F)

#Make sure it's a factor
SKN_15$Str_tr_temp <- as.factor(SKN_15$Str_tr_temp)

#Set reference level to N2 Ev
SKN_15$Str_tr_temp <- relevel(SKN_15$Str_tr_temp, ref = 'N2_ev_15')

#Name levels
SKN_15$Str_tr_temp <- factor(SKN_15$Str_tr_temp, levels = c('N2_ev_15','N2_daf_15','SKN_ev_15','SKN_daf_15','SKN_daf_15F'))

#Create survival object
surv_SKN15<-survfit(Surv(Age,Event)~Str_tr + Temperature,data=SKN_15)

#Create survival curves
SKN_15_plot <-ggsurvplot(surv_SKN15, ylab="Survival probability\n", data = SKN_15, size= 0.8, font.ylab= 18, font.xlab= 18, legend = c(0.2, 0.2), legend.title = "", title = "",palette = c('#4DBBD5FF','#E64B35FF' ,'#3C5488FF','#F39B7FFF','#00A087FF'), censor = FALSE, xlab = "\nDay", xlim=c(0,40), break.time.by = 5, position= position_dodge(0.9), font.tickslab = c(14), font.legend = c(16))

SKN_15_plot

#Exclude matricides
SKN_15_NM <- SKN_15 %>%
  filter(Cause != 'M')

#Create survival objet
surv_SKN15_NM<-survfit(Surv(Age,Event)~Str_tr + Temperature,data=SKN_15_NM)

#Create survival curves
SKN_15_NM_plot <-ggsurvplot(surv_SKN15_NM, ylab="Survival probability\n", data = SKN_15_NM, size= 0.8, font.ylab= 18, font.xlab= 18, legend = c(0.2, 0.2), legend.title = "", title = "", censor = FALSE, xlab = "\nDay", xlim=c(0,40), break.time.by = 5, position= position_dodge(0.9), font.tickslab = c(14), palette = c('#4DBBD5FF','#E64B35FF', '#3C5488FF','#F39B7FFF','#00A087FF'), font.legend = c(16))

SKN_15_NM_plot

#Exclude matricides and explosions
SKN_15_NMNE <- SKN_15 %>%
  filter(Cause != 'E' & Cause != 'M')

#Create survival object
surv_SKN15_NMNE<-survfit(Surv(Age,Event)~Str_tr + Temperature,data=SKN_15_NMNE)

#Create survival curves
SKN_15_NMNE_plot <-ggsurvplot(surv_SKN15_NMNE, ylab="Survival probability\n", data = SKN_15_NMNE, size= 0.8, font.ylab= 18, font.xlab= 18, legend = c(0.8, 0.8), legend.title = "", title = "", censor = FALSE, xlab = "\nDay", xlim=c(0,30), break.time.by = 5, position= position_dodge(0.9), font.tickslab = c(14), font.legend = c(16))

SKN_15_NMNE_plot

#Make sure Str_tr_temp is a factor
SKN_15_NM$Str_tr_temp <- as.factor(SKN_15_NM$Str_tr_temp)

#Set N2 Ev as reference level
SKN_15_NM$Str_tr_temp <- relevel(SKN_15_NM$Str_tr_temp, ref = 'N2_ev_15')

#Forest plot function
meforest <- function(cox, N2_ev_15){
  require(AICcmodavg)
  require(ggplot2)
  require(forcats)
  store <- matrix(nrow = length(cox$coefficients) + 1, ncol = 4)
  ref <- c(paste(N2_ev_15), 0,NA, NA)
  store[1,] <- ref
  for (x in 1:length(cox$coefficients)){
    y = x+1
    mean<-cox$coefficients[x]
    emean <- (mean)
    CIL <- cox$coefficients[x] - (1.96*extractSE(cox)[x])
    CUL <- cox$coefficients[x] + (1.96*extractSE(cox)[x])
    eCIL <- (CIL)
    eCUL <- (CUL)
    store[y, 1:4] <- c(names(cox$coefficients[x]), emean, eCIL, eCUL)}
  colnames(store) <- c("Str_tr_temp", "mean", "CIL","CUL")
  store <- as.data.frame(store)
  store$mean <- as.numeric(as.character(store$mean))
  store$CIL <- as.numeric(as.character(store$CIL))
  store$CUL <- as.numeric(as.character(store$CUL))
  forest<-ggplot(store, aes(x = mean, xmax = CUL, xmin = CIL, y = Str_tr_temp, colour = Str_tr_temp)) +
    geom_point(size=4, shape = 19, colour = c('#E64B35FF','#4DBBD5FF','#3C5488FF','#F39B7FFF','#00A087FF')) +
    geom_errorbarh(height=0.25, size=0.9,  colour = c('#E64B35FF','#4DBBD5FF','#3C5488FF','#F39B7FFF','#00A087FF')) +
    theme_minimal() +
    geom_vline(xintercept=0, linetype="dotted", size=0.8) +
    xlab("Hazard Ratio")+
    ylab("")+
    theme(
      axis.text = element_text(size = 16),
      axis.title = element_text(size = 18)
    )+
    scale_y_discrete(limits = (levels(store$Str_tr_temp)), labels = c('N2_ev_15' = 'N2 ev', 'Str_tr_tempN2_daf_15' = 'N2 daf-2', 'Str_tr_tempSKN_ev_15' = 'SKN-1 ev', 'Str_tr_tempSKN_daf_15' = 'SKN-1 daf-2', 'Str_tr_tempSKN_daf_15F' = 'SKN-1 daf-2 25C \n~ L2-L3')) +
    expand_limits(x = c(-0.75,0.75))
  return(forest)
}


#Mixed effects cox model for no matricides
cox_SKN_15 <- coxme(Surv(Age, Event) ~ Str_tr_temp + (1|Plate.ID), data = SKN_15_NM)

#test model
cox.zph(cox_SKN_15)#OK

#create forest plot
meforest(cox_SKN_15, 'N2_ev_15')

#mixed effects cox model with matricides
cox2 <- coxme(Surv(Age, Event) ~ Str_tr_temp + (1|Plate.ID), data = SKN_15)

#test model
cox.zph(cox2)#OK 

#create forest plot from model
SKN15_NM_forest <- meforest(cox2, 'N2_ev_15')
SKN15_NM_forest

#Combine 15C plot with forest plot
SKN_15_allplot <- ggarrange(SKN_15_NM_plot$plot, SKN15_NM_forest, nrow = 2, heights = c(1.5,1))
SKN_15_allplot

#Combined 15 and 25C plots for direct comparison
SKN_25_15_all_plot <- ggarrange(SKN_15_allplot, SKN_25_allplot, ncol = 2, labels = c('A: 15 C', 'B: 25C'))
SKN_all_plot

```

