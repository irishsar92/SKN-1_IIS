---
title: "SKN-1 dependent effects of IIS KD"
author: "Sara Irish"
date: "`r Sys.Date()`"
output: html_document
---
#Setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

suppressPackageStartupMessages({
  library(glmmTMB)
  library(car)
  library(popbio)
  library(ggplot2)
  library(ggbeeswarm)
  library(shades)
  library(RColorBrewer)
  library(DHARMa)
  library(Rmisc)
  library(dabestr)
  library(magrittr)
  library(tidyr)
  library(dplyr)
  library(ggeffects)
  library(lme4)
  library(optimx)
  library(nloptr)
  library(dfoptim)
  library(data.table)
  library(pscl)
  library(ggThemeAssist)
  library(DHARMa)
  library(emmeans)
  library(ggpubr)
  library(patchwork)
  library(lubridate)
  library(survival)
  library(coxme) #for cox model
  library(ggplot2)
  library(purrr) #for forestplot
  library(ggpubr) #for forestplot
  library(survminer) #for forestplot
  library(AICcmodavg)
  library(permutes)
  library(performance)
  library(fields)
  library(grid)
  library(ggplotify)
  library(cowplot)
  library(eha)
  library(multcomp)
  library(usethis)
  library(forcats)
})

#24-hour 15 to 25C thermocycling experiments, HF = 25C first, CF = 15C first, LS = lifespan, rep = reproduction
thermo_HF_rep <- read.csv('Thermo_H_rep.csv')
thermo_HF_LS <- read.csv('Thermo_H_LS.csv')
thermo_CF_rep <- read.csv('Thermo_C_rep.csv')
thermo_CF_LS <- read.csv('Thermo_C_LS.csv') 

#SKN-1 mutants with and without daf-2 RNAi KD in 20C - LS = lifespan, rep = reproduction
SKN_20C_rep <- read.csv('SKN1_20C_repro.csv')
SKN_20C_LS <- read.csv('SKN1_20C_LS.csv')

#Lifespan experiment SKN-1 mutants with and without daf-2 RNAi KD in 15 and 25C, with additional treatment of daf-2 RNAi KD SKN-1 mutants starting with 24 hrs of opposite temperature to test effects of temperature on early development of SKN-1 mutants
SKN_15_25_LS <- read.csv('SKN_N2_LS_15_25.csv')

#Create colour palette
palette <- c('#E64B35FF','#4DBBD5FF', '#00A087FF', '#3C5488FF')

```


#Cold first Thermocycling

Reproduction and lifespan assays following 24 hour thermo-cycling between 15 and 25C with 15C as starting temperature across four treatments: SKN-1 mutant + daf-2 RNAi, SKN-1 mutant + ev (control), N2 + daf-2 RNAi, N2 + ev

## Reproduction 
```{r}
#Dataframe into long form
thermo_c_long <- thermo_CF_rep %>% 
  pivot_longer(
    cols = c(`D1`,`D2`, `D3`, `D4`, `D5`,`D6`, `D7`,`D8`,`D9`), 
    names_to = "Day",
    values_to = "value")

#Remove unneeded columns
thermo_c_long <- thermo_c_long %>%
  dplyr::select(c('ID','Strain', 'Treatment','Day','value'))

#Remove NAs
thermo_c_long <- na.omit(thermo_c_long)

#Combine strain and treatment into one variable for plotting
thermo_c_long <- thermo_c_long %>%
  unite(Str_tr, c('Strain', 'Treatment'), remove = F)

#Set levels of StrainxTreatment
thermo_c_long$Str_tr <- factor(thermo_c_long$Str_tr, levels = c("N2_ev", "N2_daf", "SKN-1_ev", "SKN-1_daf"))

#change names of Str_tr
levels(thermo_c_long$Str_tr) <- list('N2 ev' = 'N2_ev', 'N2 daf-2' = 'N2_daf', 'SKN-1 ev' = 'SKN-1_ev', 'SKN-1 daf-2' = 'SKN-1_daf')

#Create colour palette
palette <- c('#E64B35FF','#4DBBD5FF', '#00A087FF', '#3C5488FF')

#Age-specific reproduction plot
thermo_C_p <-ggplot(data=thermo_c_long, aes(x=factor(Day), y=value, group=Str_tr, color=Str_tr))+
  geom_jitter(alpha = 0.2, position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.5))+
  stat_summary(fun.data="mean_cl_boot", geom="errorbar", size = 1.2, width=0.0, position = position_dodge(0.5)) +
  stat_summary(fun.data="mean_cl_boot", geom="point", size = 3, position = position_dodge(0.5)) +
  stat_summary(fun.data="mean_cl_boot", geom="line",  size=1.2, position = position_dodge(0.5)) +
  theme_classic()+
  labs(y="Offspring number", x="")+
  labs(col="")+
  labs(title = 'Start 15\u00B0C')+   
  theme(axis.title.y = element_text(size=14))+
  theme(axis.title.x = element_text(size=14))+
  theme(axis.text= element_text(size = 12))+
  theme(legend.text = element_text(size = 12))+
  theme(plot.title = element_text(size =12))+
  scale_color_manual(values=palette)+
  theme(legend.key.width = unit(0.5,"cm"))+
  coord_cartesian(ylim = c(0,175))+
  theme(legend.position = c(0.8, 0.9))

thermo_C_p

#Make sure Day is a factor
thermo_c_long$Day <- as.factor(thermo_c_long$Day)

#Change day to a numeric variable for analysis
levels(thermo_c_long$Day) <- list('1' = 'D1', '2' = 'D2', '3' = 'D3', '4' = 'D4', '5' = 'D5', '6' = 'D6', '7' = 'D7', '8' = 'D8', '9' = 'D9')
thermo_c_long$Day <- as.numeric(thermo_c_long$Day)


#Set ev as reference treatment level
thermo_c_long$Treatment <- as.factor(thermo_c_long$Treatment)
thermo_c_long$Treatment <- relevel(thermo_c_long$Treatment, ref = 'ev')

#Analyse age-specific repro - use glmmTMB negative binomial due to high level of zeroes
CF_m1 <- glmmTMB(value ~ Strain *Treatment*Day + (1|ID), family = nbinom1, data = thermo_c_long)

#Simulate residuals with DHARMa package to test for dispersion and zero-inflation issues
CF_sim1 <- simulateResiduals(CF_m1, plot = T)
testDispersion(CF_sim1)#underdispersed
testZeroInflation(CF_sim1)#zero-inflation

#Add zero-inflation parameter
CF_m2 <- glmmTMB(value ~ Strain * Treatment * Day + (1|ID), ziformula = ~ Day, family = 'nbinom1', data = thermo_c_long)

#SImulate residuals again to test model
CF_sim2 <- simulateResiduals(CF_m2, plot = T)
testDispersion(CF_sim2)
testZeroInflation(CF_sim2)
summary(CF_m2)

#Get chi-squared using type III Anova to account for interaction
Anova(CF_m2, type = 'III')


# Lifetime reproduction success

#Create dataframe containing Sum of total reproduction for each individual
totalrep_CF<-na.omit(as.data.frame.table(tapply(thermo_c_long$value,list(thermo_c_long$Strain, thermo_c_long$Treatment, thermo_c_long$Str_tr, thermo_c_long$ID),sum)))

#rename columns
names(totalrep_CF)<-c('Strain', 'Treatment', "Str_tr", "Replicate", "Totrep")

#Set factor levels for 
totalrep_CF$Str_tr <- factor(totalrep_CF$Str_tr, levels = c("N2 ev", "N2 daf-2", "SKN-1 ev", "SKN-1 daf-2"))

#Create dabestr object for plotting bootstrap estimations
totrep_CF_dab <-
  totalrep_CF %>%
  load(x =Str_tr, y=Totrep,
       idx = c('N2 ev','N2 daf-2', 'SKN-1 ev','SKN-1 daf-2'))

#Get mean differences from dabestr object for plotting
totrep_CF_dab_p <- mean_diff(totrep_CF_dab)

#Create Cumming estimation plot
tot_rep_plot_CF <- dabest_plot(totrep_CF_dab_p, FALSE, raw_marker_spread = 1, swarm_label = 'LRS',custom_palette = 'npg', swarm_x_text = 12, swarm_y_text = 12, contrast_y_text = 12, contrast_x_text = 12, raw_marker_alpha = 0.3, tufte_size = 1 )

tot_rep_plot_CF

#Check distribution
hist(totalrep_CF$Totrep)#close to normal

#Analyse LRS with linear model
LRS_CF <- lm(Totrep ~ Strain * Treatment, data = totalrep_CF)

#Simulate residuals
LRS_CF_sim1 <- simulateResiduals(LRS_CF, plot = T)#looks good

summary(LRS_CF)#no effect, try removing interaction

LRS_CF2 <- lm(Totrep ~ Strain + Treatment, data = totalrep_CF)

#Simulate residuals
LRS_CF_sim2 <- simulateResiduals(LRS_CF2, plot = T)#OK

summary(LRS_CF2)#trend toward higher LRS in SKN-1

#Use type II anova to get chi-squared
Anova(LRS_CF2, type = 'II')
```


## Lifespan
```{r}

#Create a combined variable for strain and treatment since forest plot can't do interactions
thermo_CF_LS <- thermo_CF_LS %>%
  unite(Str_tr, c('Strain', 'Treatment.ID'), remove = F)

#Set levels
thermo_CF_LS$Tr_str <- factor(thermo_CF_LS$Str_tr, levels = c("N2_ev", "N2_daf", "SKN-1_ev", "SKN-1_daf"))

#Set as factor
thermo_CF_LS$Str_tr <- as.factor(thermo_CF_LS$Str_tr)

#Set N2_ev as baseline level
thermo_CF_LS$Str_tr <- relevel(thermo_CF_LS$Str_tr, ref = 'N2_ev')

#Exclude unnatural causes of mortality, L = loss, W = wall, E = explosion
thermo_CF_LS <- thermo_CF_LS %>%
  filter(thermo_CF_LS$Cause != 'L' & thermo_CF_LS$Cause !='W' & thermo_CF_LS$Cause != 'E')

#Create survival object for plotting Kaplan Meier curves
surv_CF<-survfit(Surv(Age,Event)~Str_tr,data=thermo_CF_LS)

#Survival curve plot
THC_LS_plot <-ggsurvplot(surv_CF, ylab="Survival probability\n", data = thermo_CF_LS, size= 0.8, font.ylab= 14, font.xlab= 14, legend = c(0.3, 0.4), legend.title = "", title = "Start 15\u00B0C", censor = FALSE, xlab = "\nDay", xlim=c(0,40), break.time.by = 5, palette = palette, position= position_dodge(0.9), legend.labs=c("N2 ev", "N2 daf-2", "SKN-1 ev", "SKN-1 daf-2"),font.tickslab = c(12),  font.legend = c(12), font.title = c(12))
THC_LS_plot


#Create dataframe excluding matricides
thermo_CF_LSNM <- thermo_CF_LS %>%
  filter(thermo_CF_LS$Cause != 'M')

#Create survival object
survCF_NM<-survfit(Surv(Age,Event)~Str_tr,data=thermo_CF_LSNM)

#Create survival curves
LS_plot_matcen_THC <-ggsurvplot(survCF_NM, ylab="Survival probability\n", data = thermo_CF_LSNM, size= 0.8, font.ylab= 14, font.xlab= 14, legend = c(0.3, 0.4), legend.title = "", palette = palette, title = "Start 15\u00B0C", censor = FALSE, xlab = "\nDay", xlim=c(0,40), break.time.by = 5, position= position_dodge(0.9), legend.labs=c("N2 ev", "N2 daf-2", "SKN-1 ev", "SKN-1 daf-2"), font.tickslab = c(12), font.legend = c(12), font.title = c(12))
LS_plot_matcen_THC

#Sometimes NAs are produced creating an additional non-existent factor level - omit NAs first
thermo_CF_LS <- na.omit(thermo_CF_LS)
thermo_CF_LSNM <- na.omit(thermo_CF_LSNM)

#Drop non-existent factor level - or cox models get confused
thermo_CF_LS$Str_tr <- droplevels(thermo_CF_LS$Str_tr)
levels(thermo_CF_LS$Str_tr)
thermo_CF_LSNM$Str_tr <- droplevels(thermo_CF_LSNM$Str_tr)

#Mixed effects cox proportional hazards model to test effect of treatment on survival probability
CF_cox <- coxme(Surv(Age, Event) ~ Strain * Treatment.ID + (1|Plate.ID), data = thermo_CF_LS)
summary(CF_cox)
Anova(CF_cox, type = 'III')

#Test model 
cox.zph(CF_cox)#Strain * Treatment is fine
plot(cox.zph(CF_cox))

#Use emmeans because of negligible effect of plate.ID
CF_emm <- emmeans(CF_cox, ~ Treatment.ID | Strain)  # EMMs of treatment within each strain
CF_emm
#Get contrasts
contrasts_CF <- contrast(CF_emm, method = "pairwise", by = "Strain")

#make a dataframe out of the contrast summary
df_CF <- as.data.frame(summary(contrasts_CF, infer = TRUE))

# Rename columns
names(df_CF)[names(df_CF) == "estimate"] <- "logHR"
df_CF$HR <- exp(df_CF$logHR)
df_CF$lower.HR <- exp(df_CF$asymp.LCL)
df_CF$upper.HR <- exp(df_CF$asymp.UCL)

#fix labels
df_CF$Comparison <- paste0(df_CF$contrast, " (", df_CF$Strain, ")")

#Create forest plot for differences of treatments within strains
CF_contrasts <- ggplot(df_CF, aes(x = Comparison, y = logHR, colour = Strain)) +
  geom_point(size = 4) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL), width = 0.2, size = 1.1)+
  coord_flip() +
  scale_x_discrete(labels = c('N2 \n daf-2 - ev','SKN-1 \n daf-2 - ev'))+
  labs(
    title = "",
    x = "Treatment comparison \n(within strain)",
    y = "Log hazard ratio (HR)"
  ) +
    scale_colour_manual(values = c('#4DBBD5FF','#3C5488FF'))+
  theme_minimal(base_size = 12)+
  theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 14),
        legend.position = 'none')

CF_contrasts

#Mixed effects cox proportional hazards model to test effect of treatment on survival prob
CF_NM_cox <- coxme(Surv(Age, Event) ~ Strain * Treatment.ID + (1|Plate.ID), data = thermo_CF_LSNM)
summary(CF_NM_cox)
Anova(CF_NM_cox, type = 'III')

#test model
plot(cox.zph(CF_NM_cox))
cox.zph(CF_NM_cox)#close p-values - combined with plot acceptable 

#Use emmeans because of negligible effect of plate.ID
CF_NM_emm <- emmeans(CF_NM_cox, ~ Treatment.ID | Strain)  # EMMs of treatment within each strain
CF_NM_emm
#Get contrasts
contrasts_CF_NM <- contrast(CF_NM_emm, method = "pairwise", by = "Strain")
contrasts_CF_NM
#make a dataframe out of the contrast summary
df_CF_NM <- as.data.frame(summary(contrasts_CF_NM, infer = TRUE))

# Rename columns
names(df_CF_NM)[names(df_CF_NM) == "estimate"] <- "logHR"
df_CF_NM$HR <- exp(df_CF_NM$logHR)
df_CF_NM$lower.HR <- exp(df_CF_NM$asymp.LCL)
df_CF_NM$upper.HR <- exp(df_CF_NM$asymp.UCL)

#fix labels
df_CF_NM$Comparison <- paste0(df_CF_NM$contrast, " (", df_CF_NM$Strain, ")")

#Create forest plot for differences of treatments within strains
CF_NM_contrasts <- ggplot(df_CF_NM, aes(x = Comparison, y = logHR, colour = Strain)) +
  geom_point(size = 4) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL), width = 0.2, size = 1.1)+
  coord_flip() +
  scale_x_discrete(labels = c('N2 \n daf-2 - ev','SKN-1 \n daf-2 - ev'))+
  labs(
    title = "",
    x = "Treatment comparison \n(within strain)",
    y = "Log hazard ratio (HR)"
  ) +
  scale_colour_manual(values = c('#4DBBD5FF','#3C5488FF'))+
  theme_minimal(base_size = 12)+
  theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 14),
        legend.position = 'none')

CF_NM_contrasts


```



# Hot first thermocycling
Reproduction and lifespan assays following 24 hour thermo-cycling between 15 and 25C with 25C as starting temperature across four treatments: SKN-1 mutant + daf-2 RNAi, SKN-1 mutant + ev (control), N2 + daf-2 RNAi, N2 + ev

## Reproduction
```{r}
#Put dataframe into long form
thermo_h_long <- thermo_HF_rep %>% 
  pivot_longer(
    cols = c(`D1`,`D2`, `D3`, `D4`, `D5`,`D6`, `D7`,`D8`,`D9`), 
    names_to = "Day",
    values_to = "value")

#Keep only columns that are necessary
thermo_h_long <- thermo_h_long %>%
  dplyr::select(c('ID','Strain', 'Treatment','Day','value'))

#Get rid of NAs
thermo_h_long <- na.omit(thermo_h_long)

#Create a combined strain and treatment column for plotting
thermo_h_long <- thermo_h_long %>%
  unite(Str_tr, c('Strain', 'Treatment'), remove = F)

#Set factor levels for Strain x Treatment
thermo_h_long$Str_tr <- factor(thermo_h_long$Str_tr, levels = c("N2_ev", "N2_daf", "SKN-1_ev", "SKN-1_daf"))

#change names of Str_tr
levels(thermo_h_long$Str_tr) <- list('N2 ev' = 'N2_ev', 'N2 daf-2' = 'N2_daf', 'SKN-1 ev' = 'SKN-1_ev', 'SKN-1 daf-2' = 'SKN-1_daf')

#Age-specific reproduction plot
thermo_H_p <-ggplot(data=thermo_h_long, aes(x=factor(Day), y=value, group=Str_tr, color=Str_tr))+
  geom_jitter(alpha = 0.2, position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.5))+
  stat_summary(fun.data="mean_cl_boot", geom="errorbar", size = 1.2, width=0.0, position = position_dodge(0.5)) +
  stat_summary(fun.data="mean_cl_boot", geom="point", size = 3, position = position_dodge(0.5)) +
  stat_summary(fun.data="mean_cl_boot", geom="line",  size=1.2, position = position_dodge(0.5)) +
  theme_classic()+
  labs(y="Offspring number", x="")+
  labs(col="")+
  labs(title = 'Start 25\u00B0C')+
  theme(plot.title = element_text(size = 12))+
  theme(axis.title.y = element_text(size=14))+
  theme(axis.title.x = element_text(size=14))+
  theme(axis.text= element_text(size = 12))+
  theme(legend.text = element_text(size = 12))+
  scale_color_manual(values=palette)+
  theme(legend.key.width = unit(0.5,"cm"))+
  coord_cartesian(ylim = c(0,225))+
  theme(legend.position = c(0.8, 0.9))

thermo_H_p

#Make sure Day is a factor
thermo_h_long$Day <- as.factor(thermo_h_long$Day)

#Change day to a numeric variable for analysis
levels(thermo_h_long$Day) <- list('1' = 'D1', '2' = 'D2', '3' = 'D3', '4' = 'D4', '5' = 'D5', '6' = 'D6', '7' = 'D7', '8' = 'D8', '9' = 'D9')
thermo_h_long$Day <- as.numeric(thermo_h_long$Day)

#Analyse age-specific reproduction - glmmTMB with negative binomial family (will try nbinom2 to account for curvature at early days)

HF_m1 <- glmmTMB(value ~ Strain * Treatment * Day + (1|ID), family = nbinom2(), data = thermo_h_long)

#simulate residuals with DHARMa, test dispersion and zero inflation
HF_sim1 <- simulateResiduals(HF_m1, plot = T)
testDispersion(HF_sim1)# a bit underdispersed
testZeroInflation(HF_sim1)#very zero-inflated

#Try adding ZI paramter ~ Day (since 0's more likely to occur on certain days)
HF_m2 <- glmmTMB(value ~ Strain * Treatment * Day + (1|ID), family = nbinom2(), ziformula = ~Day, data = thermo_h_long)

#simualte residuals
HF_sim2 <- simulateResiduals(HF_m2, plot = T)
testDispersion(HF_sim2)#got a little worse
testZeroInflation(HF_sim2)#still very zero-inflated

#Try adding additional Treatment*Strain information into ZI parameter
HF_m3 <- glmmTMB(value ~ Strain * Treatment * Day + (1|ID), family = nbinom2(), ziformula = ~ Day * Strain * Treatment, data = thermo_h_long)

#simulate residuals
HF_sim3 <- simulateResiduals(HF_m3, plot= T)
testDispersion(HF_sim3)
testZeroInflation(HF_sim3)
summary(HF_m3)#not converging? all NA

#Try removing interactions from ziformula
HF_m4 <- glmmTMB(value ~ Strain * Treatment * Day + (1|ID), ziformula = ~ Day + Strain + Treatment, data = thermo_h_long, family = nbinom2())#won't converge

#Add OLRE - keep Day as formula
thermo_h_long <- tibble::rowid_to_column(thermo_h_long, "OLRE")
HF_m5 <- glmmTMB(value ~ Strain * Treatment * Day + (1|ID) + (1|OLRE), ziformula = ~ Day, family = nbinom2(), data = thermo_h_long)
summary(HF_m5)
HF_sim5 <- simulateResiduals(HF_m5, plot = T)
testDispersion(HF_sim5)
testZeroInflation(HF_sim5)

#Try including just strain in ziformula (because SKN-1s overall reproduced for longer)
HF_m6 <- glmmTMB(value ~ Strain * Treatment * Day + (1|ID) + (1|OLRE), ziformula = ~ Day + Strain, family = nbinom2(), data = thermo_h_long)
summary(HF_m6)#won't converge - previous model showed no signfiicant 3-way interaction - try removing

#Model without 3 way interaction
HF_m7 <- glmmTMB(value ~ Strain*Treatment + Strain * Day + Treatment *Day + (1|ID) + (1|OLRE), ziformula = ~Day + Strain, family = nbinom2(), data = thermo_h_long)
summary(HF_m7)#this converged
HF_sim7 <- simulateResiduals(HF_m7, plot = T)
testDispersion(HF_sim7)#better
testZeroInflation(HF_sim7)#better but still zero inflated

#Try adding 1 + Day as ziformula
HF_m8 <- glmmTMB(value ~ Strain*Treatment + Strain * Day + Treatment *Day + (1|ID) + (1|OLRE), ziformula = ~1+Day + Strain, family = nbinom2(), data = thermo_h_long)
summary(HF_m8)

HF_sim8 <- simulateResiduals(HF_m8, plot = T)
testDispersion(HF_sim8)#better
testZeroInflation(HF_sim8)#slightly better

#Try adding strain as interaction with day to ziformula
HF_m9 <- glmmTMB(value ~ Strain*Treatment + Strain * Day + Treatment *Day + (1|ID) + (1|OLRE), ziformula = ~1+Day * Strain, family = nbinom2(), data = thermo_h_long)
summary(HF_m9)#won't converge

#try adding strain additively to day in ziformula
HF_m10 <- glmmTMB(value ~ Strain*Treatment + Strain * Day + Treatment *Day + (1|ID) + (1|OLRE), ziformula = ~1+Day + Strain, family = nbinom1(), data = thermo_h_long)
summary(HF_m10)#doesn't converge


#Try using splines in ziformula
library(splines)
HF_m11 <- glmmTMB(value ~ Strain*Treatment + Strain*Day + Treatment*Day + (1|ID), ziformula =~ ns(Day, df = 3), family = nbinom2(), data = thermo_h_long)
summary(HF_m11)
HF_sim11 <- simulateResiduals(HF_m11, plot = T)
testDispersion(HF_sim11)
testZeroInflation(HF_sim11)
Anova(HF_m11, type = 'III')

#try df = 2 splines
HF_m11_2 <- glmmTMB(value ~ Strain*Treatment + Strain*Day + Treatment*Day + (1|ID), ziformula =~ ns(Day, df = 2), family = nbinom2(), data = thermo_h_long)

#try df = 4 splines
HF_m11_4 <- glmmTMB(value ~ Strain*Treatment + Strain*Day + Treatment*Day + (1|ID), ziformula =~ ns(Day, df = 4), family = nbinom2(), data = thermo_h_long)

#df = 3 is best - but makes little difference whether it's 2, 3, 4
AIC(HF_m11, HF_m11_2, HF_m11_4)




library(ggeffects)

# predictions for Strain x Day, group by Treatment
preds <- ggpredict(HF_m11, terms = c("Day", "Strain", "Treatment"))
plot(preds)

# try grouping by strain
preds2 <- ggpredict(HF_m11, terms = c("Day", "Treatment", "Strain"))
plot(preds2)


#Calculate total reproduction over experiment per individual
totalrep_HF<-na.omit(as.data.frame.table(tapply(thermo_h_long$value,list(thermo_h_long$Strain, thermo_h_long$Treatment, thermo_h_long$Str_tr, thermo_h_long$ID),sum)))

#rename columns
names(totalrep_HF)<-c('Strain','Treatment',"Str_tr", "Replicate", "Totrep")

#change factor levels
totalrep_HF$Str_tr <- factor(totalrep_HF$Str_tr, levels = c("N2 ev", "N2 daf-2", "SKN-1 ev", "SKN-1 daf-2"))

#Create dabestr object for Cumming estimation plot
totrep_HF_dab <-
  totalrep_HF %>%
  load(x =Str_tr, y=Totrep,
       idx = c('N2 ev','N2 daf-2', 'SKN-1 ev','SKN-1 daf-2'))

#Get mean differences for estimation plot
totrep_HF_p <- mean_diff(totrep_HF_dab)

#Create bootstrap estimation plot
tot_rep_plot_HF <- dabest_plot(totrep_HF_p, FALSE, raw_marker_spread = 1, swarm_label = 'LRS',custom_palette = 'npg', swarm_x_text = 12, swarm_y_text = 12, contrast_y_text = 12, contrast_x_text = 12, raw_marker_alpha = 0.3, tufte_size = 1 )

tot_rep_plot_HF

??dabest_plot

totalrep_HF$Treatment <- relevel(totalrep_HF$Treatment, ref = 'ev')

#Check distribution of LRS 
hist(totalrep_HF$Totrep)#normal

#Linear model to analyse total repro
LRS_HF_m1 <- lm(Totrep ~ Treatment*Strain, data = totalrep_HF)
summary(LRS_HF_m1)

#simulate residual with DHARMa package
LRS_HF_sim1 <- simulateResiduals(LRS_HF_m1, plot = T)#OK!

#Try removing interaction
LRS_HF_m2 <- lm(Totrep ~ Treatment + Strain, data = totalrep_HF)
summary(LRS_HF_m2)#SKN-1 have (significantly) lower LRS now in hot first
Anova(LRS_HF_m2, type = 'II')
#simulate residuals
LRS_HF_sim2 <- simulateResiduals(LRS_HF_m2, plot = T)#OK!


thermo_repro_all <- ggarrange(thermo_C_p + 
  theme(plot.margin = margin(t = 5, r = 25, b = 5, l = 20, unit = "pt"),plot.title = element_text(face = "bold")), thermo_H_p + 
  theme(plot.margin = margin(t = 5, r = 25, b = 5, l = 20, unit = "pt"),plot.title = element_text(face = "bold"))
, tot_rep_plot_CF+ 
  theme(plot.margin = margin(t = 5, r = 25, b = 5, l = 25, unit = "pt")), tot_rep_plot_HF+ 
  theme(plot.margin = margin(t = 5, r = 25, b = 5, l = 25, unit = "pt")), nrow = 2, ncol = 2 , common.legend = T, labels = c('A','B','C','D'))

thermo_repro_all <- as_ggplot(thermo_repro_all) +
  theme(plot.background = element_rect(fill = "white", color = NA))


ggsave("thermo_rep_all.png", plot = thermo_repro_all, bg = 'white',width = 12, height = 12, dpi = 300, units = "in")
```

## Lifespan
```{r}
#Combine Strain and Treatment into one variable for plotting
thermo_HF_LS <- thermo_HF_LS %>%
  unite(Str_tr, c('Strain', 'Treatment.ID'), remove = F)

#Make sure it's a factor
thermo_HF_LS$Str_tr <- as.factor(thermo_HF_LS$Str_tr)

#Set N2 Ev as reference level
thermo_HF_LS$Str_tr <- relevel(thermo_HF_LS$Str_tr, ref = 'N2_ev')

#FIlter out unnatural deaths (Loss, walling, explosions)
thermo_HF_LS <- thermo_HF_LS %>%
  filter(thermo_HF_LS$Cause != 'L' & thermo_HF_LS$Cause !='W' & thermo_HF_LS$Cause != 'E')

#name factor levels of Str_tr
thermo_HF_LS$Str_tr <- factor(thermo_HF_LS$Str_tr, levels = c("N2_ev", "N2_daf", "SKN-1_ev", "SKN-1_daf"))

#Check what Age is classed as
class(thermo_HF_LS$Age)

#Change to numeric
thermo_HF_LS$Age <- as.numeric(thermo_HF_LS$Age)

#Create survival object
survHF<-survfit(Surv(Age,Event)~Str_tr,data=thermo_HF_LS)

#Create a binary variable for matricides (1 = matricide, 0 = no matricide) to analyse with logistic regression
thermo_HF_LS$Matricide <- as.numeric(thermo_HF_LS$Cause == 'M')

#binomial glmer for matricide occurrence (logistic regression)
mat_mod <- glmer(Matricide ~ Str_tr + (1|Plate.ID), data = thermo_HF_LS, family = 'binomial')
summary(mat_mod)

#Create colour palette
palette <- c('#E64B35FF','#4DBBD5FF', '#00A087FF', '#3C5488FF')

#Survival curve
THH_LS_plot <-ggsurvplot(survHF, ylab="Survival probability\n", data = thermo_HF_LS, size= 0.8, font.ylab= 14, font.xlab= 14, legend = c(0.8, 0.9), legend.title = "", title = "Start 25\u00B0C", censor = FALSE, xlab = "\nDay", xlim=c(0,40), break.time.by = 5, palette = palette, position= position_dodge(0.9), legend.labs=c("N2 ev", "N2 daf-2", "SKN-1 ev", "SKN-1 daf"),font.tickslab = c(12),  font.legend = c(12), font.title = c(12))
THH_LS_plot

#Exclude matricides
thermo_HF_LSNM <- thermo_HF_LS %>%
  filter(thermo_HF_LS$Cause != 'M')

#Create survival object for matricide censored data
survHF_NM<-survfit(Surv(Age,Event)~Str_tr,data=thermo_HF_LSNM)

#Create survival curves
LS_plot_matcen_THH <-ggsurvplot(survHF_NM, ylab="Survival probability\n", data = thermo_HF_LSNM, size= 0.8, font.ylab= 14, font.xlab= 14, legend = c(0.2, 0.2), legend.title = "", palette = palette, title = "Start 25\u00B0C", censor = FALSE, xlab = "\nDay", xlim=c(0,40), break.time.by = 5, position= position_dodge(0.9), legend.labs=c("N2 ev", "N2 daf-2", "SKN-1 ev", "SKN-1 daf-1"), font.tickslab = c(12), font.legend = c(12), font.title = c(12))
LS_plot_matcen_THH

#Sometimes NAs are produced creating an additional non-existent factor level - omit NAs first
thermo_HF_LS <- na.omit(thermo_HF_LS)
thermo_HF_LSNM <- na.omit(thermo_HF_LSNM)

#Drop non-existent factor level - or cox models get confused
thermo_HF_LS$Str_tr <- droplevels(thermo_HF_LS$Str_tr)
levels(thermo_HF_LS$Str_tr)
thermo_HF_LSNM$Str_tr <- droplevels(thermo_HF_LSNM$Str_tr)

#Mixed effects cox proportional hazards model to test effect of treatment on survival probability
HF_cox <- coxme(Surv(Age, Event) ~ Strain * Treatment.ID + (1|Plate.ID), data = thermo_HF_LS)
summary(HF_cox)
Anova(HF_cox, type = 'III')

#Test model 
cox.zph(HF_cox)#check with EH analysis

#Use emmeans because of negligible effect of plate.ID
HF_emm <- emmeans(HF_cox, ~ Treatment.ID | Strain)  # EMMs of treatment within each strain
HF_emm

#Get contrasts
contrasts_HF <- contrast(HF_emm, method = "pairwise", by = "Strain")

#make a dataframe out of the contrast summary
df_HF <- as.data.frame(summary(contrasts_HF, infer = TRUE))

# Rename columns
names(df_HF)[names(df_HF) == "estimate"] <- "logHR"
df_HF$HR <- exp(df_HF$logHR)
df_HF$lower.HR <- exp(df_HF$asymp.LCL)
df_HF$upper.HR <- exp(df_HF$asymp.UCL)

#fix labels
df_HF$Comparison <- paste0(df_HF$contrast, " (", df_HF$Strain, ")")

#Create forest plot for differences of treatments within strains
HF_contrasts <- ggplot(df_HF, aes(x = Comparison, y = logHR, colour = Strain)) +
  geom_point(size = 4) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL), width = 0.2, size = 1.1)+
  coord_flip() +
  scale_x_discrete(labels = c('N2 \n daf-2 - ev','SKN-1 \n daf-2 - ev'))+
  labs(
    title = "",
    x = "Treatment comparison \n(within strain)",
    y = "Log hazard ratio (HR)"
  ) +
    scale_colour_manual(values = c('#4DBBD5FF','#3C5488FF'))+
  theme_minimal(base_size = 12)+
  theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 14),
        legend.position = 'none')

HF_contrasts

#Mixed effects cox proportional hazards model to test effect of treatment on survival prob
HF_NM_cox <- coxme(Surv(Age, Event) ~ Strain * Treatment.ID + (1|Plate.ID), data = thermo_HF_LSNM)
summary(HF_NM_cox)
Anova(HF_NM_cox, type = 'III')
#test model
plot(cox.zph(HF_NM_cox))
cox.zph(HF_NM_cox)#compare to an EH analysis

#Use emmeans because of negligible effect of plate.ID
HF_NM_emm <- emmeans(HF_NM_cox, ~ Treatment.ID | Strain)  # EMMs of treatment within each strain
HF_NM_emm

#Get contrasts
contrasts_HF_NM <- contrast(HF_NM_emm, method = "pairwise", by = "Strain")

#make a dataframe out of the contrast summary
df_HF_NM <- as.data.frame(summary(contrasts_HF_NM, infer = TRUE))

# Rename columns
names(df_HF_NM)[names(df_HF_NM) == "estimate"] <- "logHR"
df_HF_NM$HR <- exp(df_HF_NM$logHR)
df_HF_NM$lower.HR <- exp(df_HF_NM$asymp.LCL)
df_HF_NM$upper.HR <- exp(df_HF_NM$asymp.UCL)

#fix labels
df_HF_NM$Comparison <- paste0(df_HF_NM$contrast, " (", df_HF_NM$Strain, ")")

#Create forest plot for differences of treatments within strains
HF_NM_contrasts <- ggplot(df_HF_NM, aes(x = Comparison, y = logHR, colour = Strain)) +
  geom_point(size = 4) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL), width = 0.2, size = 1.1)+
  coord_flip() +
  scale_x_discrete(labels = c('N2 \n daf-2 - ev','SKN-1 \n daf-2 - ev'))+
  labs(
    title = "",
    x = "Treatment comparison \n(within strain)",
    y = "Log hazard ratio (HR)"
  ) +
  scale_colour_manual(values = c('#4DBBD5FF','#3C5488FF'))+
  theme_minimal(base_size = 12)+
  theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 14),
        legend.position = 'none')

HF_NM_contrasts


#Check with EH analysis

#Matricides included
#Change the format of the Date columns to ensure that R recognises them as actual dates
thermo_HF_LS_EH <- thermo_HF_LS %>%
  mutate(
    D1 = as.Date(paste0(D1, "-2025"), format = "%d-%b-%Y"),
    Death.Date = as.Date(paste0(Death.Date, "-2025"), format = "%d-%b-%Y")
  )

#Create an individual ID number for every worm
thermo_HF_LS_EH <- thermo_HF_LS_EH %>%
  mutate(ID = row_number())

#Create a new column status which contains '0' for any day the worm is alive and '1' for the date that it dies
EH_thermo_HF_LS <- thermo_HF_LS_EH %>%
  filter(!is.na(D1), !is.na(Death.Date)) %>%
  rowwise() %>%
  mutate(Date = list(seq(D1, Death.Date, by = "1 day"))) %>%
  unnest(Date) %>%
  ungroup() %>%
  group_by(ID) %>%
  mutate(
    Day = row_number(),    # day counter per individual
    status = if_else(Date == Death.Date, 1, 0)
  ) %>%
  ungroup() %>%
  dplyr::select(c(ID, Strain, Treatment.ID, Plate.ID, Worm, Cause, Date, Day, status, Age, Event))

#remove causes of death we want censored
EH_thermo_HF_LS <- EH_thermo_HF_LS %>%
  filter(Cause != 'W' & Cause != 'E' & Cause != 'L')

#make sure this all worked!
head(EH_thermo_HF_LS)

#run binomial glmer - include ID for repeated measures as random factor and Day to account for time on survival
EH_m1 <- glmmTMB(status ~ Strain * Treatment.ID + (1 | ID) + (1 | Day), family = "binomial",
    data = EH_thermo_HF_LS)

summary(EH_m1)#these results are the same as cox model - will use the cox model for consistency



#Matricides censored
#Change the format of the Date columns to ensure that R recognises them as actual dates
thermo_HF_LS_EHNM <- thermo_HF_LSNM %>%
  mutate(
    D1 = as.Date(paste0(D1, "-2025"), format = "%d-%b-%Y"),
    Death.Date = as.Date(paste0(Death.Date, "-2025"), format = "%d-%b-%Y")
  )

#Create an individual ID number for every worm
thermo_HF_LS_EHNM <- thermo_HF_LS_EHNM %>%
  mutate(ID = row_number())

#Create a new column status which contains '0' for any day the worm is alive and '1' for the date that it dies
EH_thermo_HF_LSNM <- thermo_HF_LS_EHNM %>%
  filter(!is.na(D1), !is.na(Death.Date)) %>%
  rowwise() %>%
  mutate(Date = list(seq(D1, Death.Date, by = "1 day"))) %>%
  unnest(Date) %>%
  ungroup() %>%
  group_by(ID) %>%
  mutate(
    Day = row_number(),    # day counter per individual
    status = if_else(Date == Death.Date, 1, 0)
  ) %>%
  ungroup() %>%
  dplyr::select(c(ID, Strain, Treatment.ID, Plate.ID, Worm, Cause, Date, Day, status, Age, Event))

#remove causes of death we want censored
EH_thermo_HF_LSNM <- EH_thermo_HF_LSNM %>%
  filter(Cause != 'W' & Cause != 'E' & Cause != 'L')

#make sure this all worked!
head(EH_thermo_HF_LSNM)

#run binomial glmer - include ID for repeated measures as random factor and Day to account for time on survival
EH_m1_NM <- glmmTMB(status ~ Strain * Treatment.ID + (1 | ID) + (1 | Day), family = "binomial",
    data = EH_thermo_HF_LSNM)

summary(EH_m1_NM)#these results are the same as cox model - will use the cox model for consistency


#Group plots for both temperature starts
thermocycle_all <- ggarrange(THC_LS_plot$plot+ theme(plot.title = element_text(face = "bold")), THH_LS_plot$plot+ theme(plot.title = element_text(face = "bold")), CF_contrasts, HF_contrasts, nrow = 2, ncol = 2, common.legend = T, labels = c('A','B','C','D'))

thermocycle_all
ggsave("thermocycle_all.png", plot = thermocycle_all, width = 12, height = 8, dpi = 300, units = "in")


#Group plots with matricides censored
thermocycle_all_NM <- ggarrange(LS_plot_matcen_THC$plot + theme(plot.title = element_text(face = "bold")), LS_plot_matcen_THH$plot+ theme(plot.title = element_text(face = "bold")), CF_NM_contrasts, HF_NM_contrasts, nrow = 2, ncol =2, common.legend = T, labels = c('A','B','C','D'))

thermocycle_all_NM

ggsave("thermocycle_NM_all.png", plot = thermocycle_all_NM, bg = 'white',width = 12, height = 8, dpi = 300, units = "in")
```


#SKN-1 in 20C
Reproduction and lifespan assays in SKN-1 mutants with daf-2 or ev (control) RNAi treatments in 20C

##Reproduction
```{r}
#put data into long form
skn_long <- SKN_20C_rep %>% 
  pivot_longer(
    cols = c(`D1`, `D2`, `D3`, `D4`, `D5`), 
    names_to = "Day",
    values_to = "value")

#select only columns needed
skn_long <- skn_long %>%
  dplyr::select(c('ID','Treatment','Day','value'))

#rename treatments
skn_long$Treatment <- as.factor(skn_long$Treatment)
levels(skn_long$Treatment) <- list('ev' = 'ev', 'daf-2' = 'daf')


#get rid of NAs
skn_long <- na.omit(skn_long)

#age-specific reproduction plot for SKN-1 mutants with daf or ev
skn_20C_p <-ggplot(data=skn_long, aes(x=factor(Day), y=value, group=Treatment, color=Treatment))+
  geom_jitter(alpha = 0.2, position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.5))+
  stat_summary(fun.data="mean_cl_boot", geom="errorbar", size = 1.2, width=0.0, position = position_dodge(0.5)) +
  stat_summary(fun.data="mean_cl_boot", geom="point", size = 3, position = position_dodge(0.5)) +
  stat_summary(fun.data="mean_cl_boot", geom="line",  size=1.2, position = position_dodge(0.5)) +
  theme_classic()+
  labs(y="Offspring number", x="Day")+
  labs(col="")+
  theme(axis.title.y = element_text(size=14))+
  theme(axis.title.x = element_text(size=14))+
  theme(axis.text= element_text(size = 12))+
  theme(legend.text = element_text(size = 12))+
  scale_color_manual(values=c('#E64B35FF','#4DBBD5FF'))+
  theme(legend.key.width = unit(0.5,"cm"))+
  coord_cartesian(ylim = c(0,225))+
  theme(legend.position = c(0.1, 0.9))

skn_20C_p

#Get Day into a numeric form
#Change day to a numeric variable for analysis
skn_long$Day <- as.factor(skn_long$Day)
levels(skn_long$Day) <- list('1' = 'D1', '2' = 'D2', '3' = 'D3', '4' = 'D4', '5' = 'D5')
skn_long$Day <- as.numeric(skn_long$Day)

#set ev as reference level
skn_long$Treatment <- as.factor(skn_long$Treatment)
skn_long$Treatment <- relevel(skn_long$Treatment, ref = 'ev')

#Age-specific reproduction aanalysis with negative binomial GLMM
m1_SKN <- glmmTMB(value ~ Treatment * Day + (1|ID), family = nbinom2(), data = skn_long)
summary(m1_SKN)

#model diagnostics
sim_SKN1 <- simulateResiduals(m1_SKN, plot = T)
testDispersion(sim_SKN1)#underdispersed
testZeroInflation(sim_SKN1)#zero-inflated

#Try adding zero inflation formula
m2_SKN <- glmmTMB(value ~ Treatment*Day + (1|ID), ziformula = ~Day, family = nbinom2(), data = skn_long)
summary(m2_SKN)#won't converge, try removing interaction (appears nonsig in previous model)

#Remove interaction
m3_SKN <- glmmTMB(value ~ Treatment + Day + (1|ID), family = nbinom2(), ziformula = ~ Day, data = skn_long)
summary(m3_SKN)

#diagnostic
sim_SKN3 <- simulateResiduals(m3_SKN, plot = T)
testZeroInflation(sim_SKN3)
testDispersion(sim_SKN3)

### Try a poisson model
m4_SKN <- glmmTMB(value ~ Treatment * Day + (1|ID), family = poisson(), data = skn_long)
AIC(m1_SKN, m4_SKN)#poisson has MUCH higher AIC

#compare other models
AIC(m1_SKN, m2_SKN, m3_SKN) #m3 is worse than m1

#Try adding Day^2
m5_SKN <- glmmTMB(value ~ Treatment * I(Day^2) + Treatment*Day + (1|ID), family = nbinom2(), data = skn_long)
AIC(m1_SKN, m5_SKN)#huge improvement
sim_SKN5 <- simulateResiduals(m5_SKN, plot = T)
testDispersion(sim_SKN5)
testZeroInflation(sim_SKN5)
summary(m5_SKN)

#Try adding zi formula
m6_SKN <- glmmTMB(value ~ Treatment * I(Day^2) + Treatment*Day + (1|ID), ziformula = ~Day, family = nbinom2(), data = skn_long)
#won't converge

#Remove interaction between Treatment and Day
m7_SKN <- glmmTMB(value ~ Treatment*I(Day^2) + Day + (1|ID), ziformula = ~Day, family = nbinom2(), data = skn_long)
summary(m7_SKN)
Anova(m7_SKN, type = 'III')
sim_SKN7 <- simulateResiduals(m7_SKN, plot = T)
testDispersion(sim_SKN7)

m8_SKN <- glmmTMB(value ~ Treatment * Day + I(Day^2) + (1|ID), ziformula = ~Day, family = nbinom2(), data = skn_long )
AIC(m7_SKN, m8_SKN)#these models are pretty much the same - use previous one as interest is in how treatment affect offspring number of days in curved day variable
sim_SKN8 <- simulateResiduals(m8_SKN, plot = T)
testDispersion(sim_SKN8)

#sum up total number of offspring produced over experiment per individual
totalrep_SKN<-na.omit(as.data.frame.table(tapply(skn_long$value,list(skn_long$Treatment, skn_long$ID),sum)))

#rename columns
names(totalrep_SKN)<-c("Treatment", "Replicate", "Totrep")


#create dabestr object for plotting cumming estimation
totrep_SKN_dab <-
  totalrep_SKN %>%
  load(x =Treatment, y=Totrep,
       idx = c('ev','daf-2'))

#get mean differences for plot
totrep_SKN_p <- mean_diff(totrep_SKN_dab)

#cumming estimation plot for LRS in SKN-1 at 20C with daf or ev
tot_rep_SKN_plot <- dabest_plot(totrep_SKN_p, FALSE, raw_marker_spread = 1, swarm_label = 'LRS',custom_palette = 'npg', swarm_x_text = 14, swarm_y_text = 14, contrast_y_text = 16, contrast_x_text = 14, raw_marker_alpha = 0.3, tufte_size = 1 )
tot_rep_SKN_plot


#Look at distribution
  hist(totalrep_SKN$Totrep)#pretty skewed - but try LM

#Try running basic linear model
SKN_LRS_m1 <- lm(value ~ Treatment, data = skn_long)
summary(SKN_LRS_m1)
SKN_LRS_sim1 <- simulateResiduals(SKN_LRS_m1, plot = T)

#Try a Gamma GLM
SKN_LRS_m2 <- glm(Totrep ~ Treatment, data = totalrep_SKN, family = Gamma(link = 'log'))
summary(SKN_LRS_m2)
SKN_LRS_sim2 <- simulateResiduals(SKN_LRS_m2, plot = T)

#Try link = inverse
SKN_LRS_m3 <- glm(Totrep ~ Treatment, data = totalrep_SKN, family = Gamma(link = 'inverse'))
summary(SKN_LRS_m3)
SKN_LRS_sim3 <- simulateResiduals(SKN_LRS_m3, plot = T)
Anova(SKN_LRS_m3, type = 'II')

totalrep_SKN$Treatment <- as.factor(totalrep_SKN$Treatment)
new_data2 <- data.frame(Treatment = levels(totalrep_SKN$Treatment))

# Predict on response scale (i.e., expected Totrep, not log)
pred <- predict(SKN_LRS_m2, newdata = new_data2, type = "response", se.fit = TRUE)

# Add predictions to data frame
new_data2$fit <- pred$fit
new_data2$se <- pred$se.fit
new_data2$lower <- new_data2$fit - 1.96 * new_data2$se
new_data2$upper <- new_data2$fit + 1.96 * new_data2$se

ggplot(new_data2, aes(x = Treatment, y = fit)) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2) +
  labs(y = "Predicted LRS", 
       title = "Gamma GLM predictions") +
  theme_minimal()
#predictions look right, stick with Gamma model

```

##Lifespan
```{r}

#Get rid of NAs
SKN_20C_LS <- na.omit(SKN_20C_LS)

#Rename daf to daf-2
SKN_20C_LS$Treatment.ID <- revalue(SKN_20C_LS$Treatment.ID, c('ev' = 'ev', 'daf' = 'daf-2'))

#Make sure Treatment is a factor
SKN_20C_LS$Treatment.ID <- as.factor(SKN_20C_LS$Treatment.ID)

#Make ev the baseline level
SKN_20C_LS$Treatment.ID <- relevel(SKN_20C_LS$Treatment.ID, ref = 'ev')

#Check factor levels of treatment
levels(SKN_20C_LS$Treatment.ID)

#Get rid of empty levels
SKN_20C_LS$Treatment.ID <- droplevels(SKN_20C_LS$Treatment.ID)

#Plate.ID as a factor not a numerical
SKN_20C_LS$Plate.ID <- as.factor(SKN_20C_LS$Plate.ID)

#Create survival object for SKN-1 mutants at 20C
surv_SKN<-survfit(Surv(Age,Event)~Treatment.ID,data=SKN_20C_LS)

#Create survival curve from survival object
SKN_20C_LS_plot <-ggsurvplot(surv_SKN, ylab="Survival probability\n", data = SKN_20C_LS, size= 0.8, font.ylab= 14, font.xlab= 14, palette=c('#E64B35FF','#4DBBD5FF'), legend = c(0.8, 0.8), legend.title = "", legend.labs = c('ev','daf-2'), title = "", censor = FALSE, xlab = "Day", xlim=c(0,35), break.time.by = 5, position= position_dodge(0.9), font.tickslab = c(12), font.legend = c(12))

SKN_20C_LS_plot

#Mixed effects cox model for a effect of daf-2 on SKN-1 mutant lifespan
cox_SKN_20C <- coxme(Surv(Age, Event) ~ Treatment.ID + (1|Plate.ID), data = SKN_20C_LS)
summary(cox_SKN_20C)
Anova(cox_SKN_20C, type = 'II')

#test model
cox.zph(cox_SKN_20C)#OK


#Use emmeans because of negligible effect of plate.ID
SKN_emm <- emmeans(cox_SKN_20C, ~ Treatment.ID)  # EMMs of treatment 
SKN_emm

#Get contrasts
contrasts_SKN <- contrast(SKN_emm, method = "revpairwise")

#make a dataframe out of the contrast summary
df_SKN <- as.data.frame(summary(contrasts_SKN, infer = TRUE))

# Rename columns
names(df_SKN)[names(df_SKN) == "estimate"] <- "logHR"
df_SKN$HR <- exp(df_SKN$logHR)
df_SKN$lower.HR <- exp(df_SKN$asymp.LCL)
df_SKN$upper.HR <- exp(df_SKN$asymp.UCL)

#fix labels
df_SKN$Comparison <- df_SKN$contrast

#Create forest plot for differences of treatments within strains
SKN_contrasts <- ggplot(df_SKN, aes(x = Comparison, y = logHR)) +
  geom_point(size = 4, color = '#4DBBD5FF') +
  geom_hline(yintercept = 0, linetype = "dashed", size = 1.2, color = 'grey50') +
  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL), width = 0.2, size = 1.1,color ='#4DBBD5FF')+
  coord_flip() +
  #scale_x_discrete(labels = c('N2 \n daf-2 - ev','SKN-1 \n daf-2 - ev'))+
  labs(
    title = "",
    x = "Treatment comparison",
    y = "Log hazard ratio (HR)"
  ) +
  theme_minimal(base_size = 12)+
  theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 14),
        legend.position = 'none')

SKN_contrasts

#Exclude matricides
SKN_20C_LS_NM <- SKN_20C_LS %>%
  filter(Cause != 'M')

#Create survival object
surv_SKN_NM<-survfit(Surv(Age,Event)~Treatment.ID,data=SKN_20C_LS_NM)

#Survival plot
SKN_NM_LS_plot <-ggsurvplot(surv_SKN_NM, ylab="Survival probability", data = SKN_20C_LS_NM, size= 0.8, font.ylab= 14, font.xlab= 14, palette=c('#E64B35FF','#4DBBD5FF'), legend = c(0.8, 0.8), legend.title = "", legend.labs = c('ev','daf-2'), title = "", censor = FALSE, xlab = "Day", xlim=c(0,35), break.time.by = 5, position= position_dodge(0.9), font.tickslab = c(12), font.legend = c(12))

SKN_NM_LS_plot

#Cox mixed effects model
cox_SKN_20C_NM <- coxme(Surv(Age, Event) ~ Treatment.ID + (1|Plate.ID), data = SKN_20C_LS_NM)
summary(cox_SKN_20C_NM)
Anova(cox_SKN_20C_NM, type = 'II')
#Test model
cox.zph(cox_SKN_20C_NM)#OK

#Use emmeans because of negligible effect of plate.ID
SKN_NM_emm <- emmeans(cox_SKN_20C_NM, ~ Treatment.ID)  # EMMs of treatment 
SKN_NM_emm

#Get contrasts
contrasts_SKN_NM <- contrast(SKN_NM_emm, method = "revpairwise")

#make a dataframe out of the contrast summary
df_SKN_NM <- as.data.frame(summary(contrasts_SKN_NM, infer = TRUE))

# Rename columns
names(df_SKN_NM)[names(df_SKN_NM) == "estimate"] <- "logHR"
df_SKN_NM$HR <- exp(df_SKN_NM$logHR)
df_SKN_NM$lower.HR <- exp(df_SKN_NM$asymp.LCL)
df_SKN_NM$upper.HR <- exp(df_SKN_NM$asymp.UCL)

#fix labels
df_SKN_NM$Comparison <- df_SKN_NM$contrast

#Create forest plot for differences of treatments within strains
SKN_NM_contrasts <- ggplot(df_SKN_NM, aes(x = Comparison, y = logHR)) +
  geom_point(size = 4, color = '#4DBBD5FF') +
  geom_hline(yintercept = 0, linetype = "dashed", size = 1.2, color = 'grey50') +
  geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL), width = 0.2, size = 1.1,color ='#4DBBD5FF')+
  coord_flip() +
  #scale_x_discrete(labels = c('N2 \n daf-2 - ev','SKN-1 \n daf-2 - ev'))+
  labs(
    title = "",
    x = "Treatment comparison",
    y = "Log hazard ratio (HR)"
  ) +
  theme_minimal(base_size = 12)+
  theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 14),
        legend.position = 'none')

SKN_NM_contrasts

#Group all plots for 20C skn-1 data
SKN_20C_all <- ggarrange(SKN_NM_LS_plot$plot, skn_20C_p, SKN_NM_contrasts+theme(plot.margin = margin(t = 5, r = 5, b = 25, l = 40, unit = "pt")), tot_rep_SKN_plot+theme(plot.margin = margin(t = 5, r = 5, b = 5, l = 40, unit = "pt")), heights = c(1.3, 1), common.legend = T, labels = c('A','B','C','D'))
SKN_20C_all


ggsave("SKN_20C_all.png", plot = SKN_20C_all, bg = 'white',width = 12, height = 10, dpi = 300, units = "in")
```

# SKN-1 in 25C
Lifespan assays in SKN-1 mutants and N2s with daf-2 or ev (control) RNAi treatments in 25C, including a treatment with a single 24-hour cycle of 15C at ~ L2 stage
## Lifespan
```{r}

#Temperature as a factor
SKN_15_25_LS$Temperature <- as.factor(SKN_15_25_LS$Temperature)

#Get only 25C data
SKN_25 <- SKN_15_25_LS %>%
  filter(Temperature != '15' & Temperature != '15F')

#Combine Strain and treatment for plotting
SKN_25 <- SKN_25 %>%
  unite(Str_tr, 'Strain','Treatment.ID', remove = F)

#Also combine temperature with strain and treatment
SKN_25 <- SKN_25 %>%
  unite(Str_tr_temp, 'Str_tr', 'Temperature', remove = F)

#Rename factor levels
SKN_25$Str_tr_temp <- factor(SKN_25$Str_tr_temp, levels = c('N2_ev_25','N2_daf_25','SKN_ev_25','SKN_daf_25','SKN_daf_25F'))

#Ensure it's a factor
SKN_25$Str_tr_temp <- as.factor(SKN_25$Str_tr_temp)

#Set ev N2 with 25C only as reference level
SKN_25$Str_tr_temp <- relevel(SKN_25$Str_tr_temp, ref = 'N2_ev_25')

#Create survival object for plot
surv_SKN25<-survfit(Surv(Age,Event)~Str_tr + Temperature,data=SKN_25)

#Create survival curve
SKN_25_plot <-ggsurvplot(surv_SKN25, ylab="Survival probability\n", data = SKN_25, size= 0.8, font.ylab= 14, font.xlab= 14, legend = c(0.8, 0.8), legend.title = "", title = "25°C", palette = c('#4DBBD5FF','#E64B35FF' ,'#3C5488FF','#F39B7FFF','#00A087FF'),censor = FALSE, xlab = "\nDay", xlim=c(0,30), break.time.by = 5, position= position_dodge(0.9), font.tickslab = c(12), font.legend = c(12),legend.labs = c('N2 daf-2', 'N2 ev','SKN-1 daf-2','SKN-1 daf-2 + cycle','SKN-1 ev'))

SKN_25_plot

#Exclude matricides
SKN_25_NM <- SKN_25 %>%
  filter(Cause != 'M')

#Create survival object
surv_SKN25_NM<-survfit(Surv(Age,Event)~Str_tr + Temperature,data=SKN_25_NM)

#Create survival curve
SKN_25_NM_plot <-ggsurvplot(surv_SKN25_NM, ylab="Survival probability\n", data = SKN_25_NM, size= 0.8, font.ylab= 14, font.xlab= 14, legend = c(0.8, 0.8), legend.title = "", title = "25°C", palette = c('#4DBBD5FF','#E64B35FF' ,'#3C5488FF','#F39B7FFF','#00A087FF'), censor = FALSE, xlab = "\nDay", xlim=c(0,30), break.time.by = 5, position= position_dodge(0.9), font.tickslab = c(12), font.legend = c(12),legend.labs = c('N2 daf-2', 'N2 ev','SKN-1 daf-2','SKN-1 daf-2 + cycle','SKN-1 ev'))

SKN_25_NM_plot


#Make sure Str-tr_temp is a factor
SKN_25_NM$Str_tr_temp <- as.factor(SKN_25_NM$Str_tr_temp)

#Reset baseline to ev N2 in 25 only
SKN_25_NM$Str_tr_temp <- relevel(SKN_25_NM$Str_tr_temp, ref = 'N2_ev_25')


#Analyse within strains becaues of additional treatment only in SKN-1

#FIlter only SKNs 
SKN_only_25 <- SKN_25 %>%
  filter(Strain == 'SKN')

str(SKN_only_25)

#Check levels of Strain
SKN_only_25$Strain <- as.factor(SKN_only_25$Strain)
levels(SKN_only_25$Strain)

#Check levels of temperature
levels(SKN_only_25$Temperature)

#Need to drop levels - still thinks it has 15C treatments 
SKN_only_25$Temperature <- droplevels(SKN_only_25$Temperature)
levels(SKN_only_25$Temperature)

#Check levels of Treatment
SKN_only_25$Treatment.ID <- as.factor(SKN_only_25$Treatment.ID)
levels(SKN_only_25$Treatment.ID)
SKN_only_25$Treatment.ID <- droplevels(SKN_only_25$Treatment.ID)

#Combine Treatment and temperature because of imbalance
SKN_only_25 <- SKN_only_25 %>%
  unite(Tr_temp, 'Treatment.ID','Temperature', remove = F)

#set ev as reference level
SKN_only_25$Tr_temp <- as.factor(SKN_only_25$Tr_temp)
SKN_only_25$Tr_temp <- relevel(SKN_only_25$Tr_temp, ref = 'ev_25')

#Coxme model with combined effect of treatment and temperature to account for developmental thermocycle treatment
cox_SKN_25_only <- coxme(Surv(Age, Event) ~ Tr_temp + (1|Plate.ID), data = SKN_only_25)
summary(cox_SKN_25_only)
Anova(cox_SKN_25_only, type = 'II')
#test model
cox.zph(cox_SKN_25_only)# global p = 0.004 - check with EH analysis

#Matricides censored
SKN_only_25_NM <- SKN_only_25 %>%
  filter(Cause !='M')

#Coxme model with combined effect of treatment and temperature to account for developmental thermocycle treatment with matricides censored
cox_SKN_25_only_NM <- coxme(Surv(Age, Event) ~ Tr_temp + (1|Plate.ID), data = SKN_only_25_NM)
summary(cox_SKN_25_only_NM)
Anova(cox_SKN_25_only_NM, type = 'II')

#test model
cox.zph(cox_SKN_25_only_NM)# global p = 0.054 OK


#Filter out N2s
N2_only_25 <- SKN_25 %>%
  filter(Strain == 'N2')

#Set ev as reference level
N2_only_25$Treatment.ID <- as.factor(N2_only_25$Treatment.ID)
N2_only_25$Treatment.ID <- relevel(N2_only_25$Treatment.ID, ref = 'ev')

#Coxme model with treatment as factor
cox_N2_only <- coxme(Surv(Age, Event) ~ Treatment.ID + (1|Plate.ID), data = N2_only_25)
summary(cox_N2_only)
Anova(cox_N2_only, type = 'II')

#test model
cox.zph(cox_N2_only)#OK p>0.05

#Censor matricides
N2_only_25_NM <- N2_only_25 %>%
  filter(Cause !='M')

#coxme model with treatment as factor with matricides censored
cox_N2_only_NM <- coxme(Surv(Age, Event) ~ Treatment.ID + (1|Plate.ID), data = N2_only_25_NM)
summary(cox_N2_only_NM)
Anova(cox_N2_only_NM, type = 'II')

#test model
cox.zph(cox_N2_only_NM)#p > 0.05 OK

#Check with EH analysis

#Matricides included
#Change the format of the Date columns to actual dates and add ID
SKN_only_25_EH<- SKN_only_25 %>%
  mutate(
    D1 = as.Date(paste0(D1, "-2025"), format = "%d-%b-%Y"),
    Death.Date = as.Date(paste0(Death.Date, "-2025"), format = "%d-%b-%Y"))%>%
  mutate(ID = row_number())



#Create a new column status which contains '0' for any day the worm is alive and '1' for the date that it dies
EH_SKN_only_25 <- SKN_only_25_EH %>%
  filter(!is.na(D1), !is.na(Death.Date)) %>%
  rowwise() %>%
  mutate(Date = list(seq(D1, Death.Date, by = "1 day"))) %>%
  unnest(Date) %>%
  ungroup() %>%
  group_by(ID) %>%
  mutate(
    Day = row_number(),    # day counter per individual
    status = if_else(Date == Death.Date, 1, 0)
  ) %>%
  ungroup() %>%
  dplyr::select(c(ID, Strain, Tr_temp,Treatment.ID, Plate.ID, Worm, Cause, Date, Day, status, Age, Event))

#remove causes of death we want censored
EH_SKN_only_25 <- EH_SKN_only_25 %>%
  filter(Cause != 'W' & Cause != 'E' & Cause != 'L')

#make sure this all worked!
head(EH_SKN_only_25)

#run binomial glmer - include ID for repeated measures as random factor and Day to account for time on survival
SKN_25_EH_m1 <- glmmTMB(status ~ Tr_temp + (1 | ID) + (1 | Day), family = "binomial",
    data = EH_SKN_only_25)

summary(SKN_25_EH_m1)#these results are the same as cox model - will use the cox model for consistency

#Get contrasts - matricides included
SKN_25_em1 <- emmeans(cox_SKN_25_only, "Tr_temp")
N2_25_em2 <- emmeans(cox_N2_only, "Treatment.ID")
SKN_25_c1 <- contrast(SKN_25_em1, method = "revpairwise")  # or whatever method suits
N2_25_c2 <- contrast(N2_25_em2, method = "revpairwise")

#put contrasts into df and name
SKN_25_c1_df <- as.data.frame(SKN_25_c1)
SKN_25_c1_df$model <- "SKN-1"
N2_25_c2_df <- as.data.frame(N2_25_c2)
N2_25_c2_df$model <- "N2"

#calculate Cis
SKN_25_c1_df$lower.CL <- SKN_25_c1_df$estimate - 1.96 * SKN_25_c1_df$SE
SKN_25_c1_df$upper.CL <- SKN_25_c1_df$estimate + 1.96 * SKN_25_c1_df$SE
N2_25_c2_df$lower.CL <- N2_25_c2_df$estimate - 1.96 * N2_25_c2_df$SE
N2_25_c2_df$upper.CL <- N2_25_c2_df$estimate + 1.96 *N2_25_c2_df$SE

#combine dfs
all_25_df <- rbind(SKN_25_c1_df, N2_25_c2_df)

#remove contrast of daf-25F to daf-25
all_25_df <- all_25_df %>%
  filter(contrast != 'daf_25F - daf_25')

# Optional: create a combined label
all_25_df$label <- paste(all_25_df$model, all_25_df$contrast, sep = ": ")



#change contrast names
all_25_df$contrast <- fct_recode(all_25_df$contrast,
  "SKN-1: daf-2 - ev" = "daf_25 - ev_25",
  "SKN-1: daf-2 with cycle - ev" = "daf_25F - ev_25",
  "N2: daf-2 - ev" = "daf - ev")

levels(all_25_df$contrast)

#make labels for plot
all_25_df <- all_25_df %>%
  mutate(label = recode(label,
    "SKN-1: daf_25 - ev_25"  = "SKN-1: daf-2 - ev",
    "SKN-1: daf_25F - ev_25" = "SKN-1: daf-2 with cycle - ev",
    "N2: daf - ev"           = "N2: daf-2 - ev"
  ))

#Plot HRs for N2 and SKN-1 together
SKN_N2_25_HR <- ggplot(all_25_df, aes(x = estimate, y = label, color = contrast)) +
  geom_point(size = 4) +
  geom_errorbarh(aes(xmin = lower.CL, xmax = upper.CL), height = 0.2, linewidth = 1.1) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50", size = 1.1) +
  labs(x = "Log Hazard Ratio", y = "") +
  scale_color_manual(values = c('#4DBBD5FF', '#3C5488FF','#F39B7FFF'))+
  theme_minimal()+
    theme(legend.position = 'none',
         axis.text= element_text(size = 12),
         axis.title = element_text(size = 14))+
  guides(color = "none", fill = "none", shape = "none")
  
SKN_N2_25_HR

#Get EMMS - matricides censored
SKN_25NM_em1 <- emmeans(cox_SKN_25_only_NM, "Tr_temp")
N2_25NM_em2 <- emmeans(cox_N2_only_NM, "Treatment.ID")

#Get contrasts
SKN_25NM_c1 <- contrast(SKN_25NM_em1, method = "revpairwise")  # or whatever method suits
N2_25NM_c2 <- contrast(N2_25NM_em2, method = "revpairwise")

#Make contrasts into df and name
SKN_25NM_c1_df <- as.data.frame(SKN_25NM_c1)
SKN_25NM_c1_df$model <- "SKN-1"

#Make contrasts into df and name
N2_25NM_c2_df <- as.data.frame(N2_25NM_c2)
N2_25NM_c2_df$model <- "N2"

#calculate CI
SKN_25NM_c1_df$lower.CL <- SKN_25NM_c1_df$estimate - 1.96 * SKN_25NM_c1_df$SE
SKN_25NM_c1_df$upper.CL <- SKN_25NM_c1_df$estimate + 1.96 * SKN_25NM_c1_df$SE

#calculate CI
N2_25NM_c2_df$lower.CL <- N2_25NM_c2_df$estimate - 1.96 * N2_25NM_c2_df$SE
N2_25NM_c2_df$upper.CL <- N2_25NM_c2_df$estimate + 1.96 *N2_25NM_c2_df$SE

#combine datasets for SKN and N2 into one for plot
all_25NM_df <- rbind(SKN_25NM_c1_df, N2_25NM_c2_df)

#Exclude daf-25cycle and daf-25 contrast - want to know how it's different from controls
all_25NM_df <- all_25NM_df %>%
  filter(contrast != 'daf_25F - daf_25')

# create a combined label
all_25NM_df$label <- paste(all_25NM_df$model, all_25NM_df$contrast, sep = ": ")


#change contrast names
all_25NM_df$contrast <- fct_recode(all_25NM_df$contrast,
  "SKN-1: daf-2 - ev" = "daf_25 - ev_25",
  "SKN-1: daf-2 with cycle - ev" = "daf_25F - ev_25",
  "N2: daf-2 - ev" = "daf - ev")

levels(all_25NM_df$contrast)

#make them labels for plot
all_25NM_df <- all_25NM_df %>%
  mutate(label = recode(label,
    "SKN-1: daf_25 - ev_25"  = "SKN-1: daf-2 - ev",
    "SKN-1: daf_25F - ev_25" = "SKN-1: daf-2 with cycle - ev",
    "N2: daf - ev"           = "N2: daf-2 - ev"
  ))

#create plot combining N2 and SKN 
SKN_N2_25NM_HR <- ggplot(all_25NM_df, aes(x = estimate, y = label, color = contrast)) +
  geom_point(size = 4) +
  geom_errorbarh(aes(xmin = lower.CL, xmax = upper.CL), height = 0.2, linewidth = 1.1) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50", size = 1.1) +
  labs(x = "Log Hazard Ratio", y = "") +
  scale_color_manual(values = c('#4DBBD5FF', '#3C5488FF','#F39B7FFF'))+
  theme_minimal()+
    theme(legend.position = 'none',
         axis.text= element_text(size = 12),
         axis.title = element_text(size = 14))+
  guides(color = "none", fill = "none", shape = "none")

SKN_N2_25NM_HR

```

# SKN-1 in 15C
Lifespan assays in SKN-1 mutants and N2s with daf-2 or ev (control) RNAi treatments in 15C, including a treatment with a single 24-hour cycle of 25C at ~ L2 stage
##Lifespan
```{r}

#Include only 15C data
SKN_15 <- SKN_15_25_LS %>%
  filter(Temperature != '25' & Temperature != '25F')

#Unite strain and treatment for plotting
SKN_15 <- SKN_15 %>%
  unite(Str_tr, 'Strain','Treatment.ID', remove = F)

#Unite strain, treatment and temperature for plotting
SKN_15 <- SKN_15 %>%
  unite(Str_tr_temp, 'Str_tr', 'Temperature', remove = F)

#Make sure it's a factor
SKN_15$Str_tr_temp <- as.factor(SKN_15$Str_tr_temp)

#Set reference level to N2 Ev
SKN_15$Str_tr_temp <- relevel(SKN_15$Str_tr_temp, ref = 'N2_ev_15')

#Name levels
SKN_15$Str_tr_temp <- factor(SKN_15$Str_tr_temp, levels = c('N2_ev_15','N2_daf_15','SKN_ev_15','SKN_daf_15','SKN_daf_15F'))

#Create survival object
surv_SKN15<-survfit(Surv(Age,Event)~Str_tr + Temperature,data=SKN_15)

#Create survival curves
SKN_15_plot <-ggsurvplot(surv_SKN15, ylab="Survival probability\n", data = SKN_15, size= 0.8, font.ylab= 14, font.xlab= 14, legend = c(0.2, 0.2), legend.title = "", title = "15°C",palette = c('#4DBBD5FF','#E64B35FF' ,'#3C5488FF','#F39B7FFF','#00A087FF'), censor = FALSE, xlab = "\nDay", xlim=c(0,40), break.time.by = 5, position= position_dodge(0.9), font.tickslab = c(12), font.legend = c(12), legend.labs = c('N2 daf-2', 'N2 ev','SKN-1 daf-2','SKN-1 daf-2 + cycle','SKN-1 ev'))

SKN_15_plot

#Exclude matricides
SKN_15_NM <- SKN_15 %>%
  filter(Cause != 'M')

#Create survival objet
surv_SKN15_NM<-survfit(Surv(Age,Event)~Str_tr + Temperature,data=SKN_15_NM)

#Create survival curves
SKN_15_NM_plot <-ggsurvplot(surv_SKN15_NM, ylab="Survival probability\n", data = SKN_15_NM, size= 0.8, font.ylab= 14, font.xlab= 14, legend = c(0.2, 0.2), legend.title = "", title = "15°C", censor = FALSE, xlab = "\nDay", xlim=c(0,40), break.time.by = 5, position= position_dodge(0.9), font.tickslab = c(12), palette = c('#4DBBD5FF','#E64B35FF', '#3C5488FF','#F39B7FFF','#00A087FF'), font.legend = c(12),legend.labs = c('N2 daf-2', 'N2 ev','SKN-1 daf-2','SKN-1 daf-2 + cycle','SKN-1 ev'))

SKN_15_NM_plot


#Analyse two strains individually due to additionally treatment of thermocycling during development in SKN-1 only
#FIlter only SKNs 
SKN_only_15 <- SKN_15 %>%
  filter(Strain == 'SKN')

str(SKN_only_15)

#Check levels of Strain
SKN_only_15$Strain <- as.factor(SKN_only_15$Strain)
levels(SKN_only_15$Strain)

#Check levels of temperature
levels(SKN_only_15$Temperature)

#Need to drop levels - still thinks it has 15C treatments 
SKN_only_15$Temperature <- droplevels(SKN_only_15$Temperature)
levels(SKN_only_15$Temperature)

#Check levels of Treatment
SKN_only_15$Treatment.ID <- as.factor(SKN_only_15$Treatment.ID)
levels(SKN_only_15$Treatment.ID)
SKN_only_15$Treatment.ID <- droplevels(SKN_only_15$Treatment.ID)

#Combine Treatment and temperature because of imbalance
SKN_only_15 <- SKN_only_15 %>%
  unite(Tr_temp, 'Treatment.ID','Temperature', remove = F)

#set ev as reference level
SKN_only_15$Tr_temp <- as.factor(SKN_only_15$Tr_temp)
SKN_only_15$Tr_temp <- relevel(SKN_only_15$Tr_temp, ref = 'ev_15')

#Coxme model with combined effect of treatment and temperature to account for developmental thermocycle treatment
cox_SKN_15_only <- coxme(Surv(Age, Event) ~ Tr_temp + (1|Plate.ID), data = SKN_only_15)
summary(cox_SKN_15_only)
Anova(cox_SKN_15_only, type = 'II')

#test model
cox.zph(cox_SKN_15_only)# OK! p = 0.18

#Matricides censored
SKN_only_15_NM <- SKN_only_15 %>%
  filter(Cause !='M')

#Coxme model with combined effect of treatment and temperature to account for developmental thermocycle treatment with matricides censored
cox_SKN_15_only_NM <- coxme(Surv(Age, Event) ~ Tr_temp + (1|Plate.ID), data = SKN_only_15_NM)
summary(cox_SKN_15_only_NM)
Anova(cox_SKN_15_only_NM, type = 'II')
#test model
cox.zph(cox_SKN_15_only_NM)# global p = 0.41, OK!


#Filter out N2s
N2_only_15 <- SKN_15 %>%
  filter(Strain == 'N2')

#Set ev as reference level
N2_only_15$Treatment.ID <- as.factor(N2_only_15$Treatment.ID)
N2_only_15$Treatment.ID <- relevel(N2_only_15$Treatment.ID, ref = 'ev')

#Coxme model with treatment as factor
cox_N2_15_only <- coxme(Surv(Age, Event) ~ Treatment.ID + (1|Plate.ID), data = N2_only_15)
summary(cox_N2_15_only)
Anova(cox_N2_15_only, type = 'II')

#test model
cox.zph(cox_N2_15_only)#OK p = 0.79

#Censor matricides
N2_only_15_NM <- N2_only_15 %>%
  filter(Cause !='M')

#coxme model with treatment as factor with matricides censored
cox_N2_15_only_NM <- coxme(Surv(Age, Event) ~ Treatment.ID + (1|Plate.ID), data = N2_only_15_NM)
summary(cox_N2_15_only_NM)
Anova(cox_N2_15_only_NM, type = 'II')
#test model
cox.zph(cox_N2_15_only_NM)#p = 0.87 OK


#Get contrasts - matricides included
SKN_15_em1 <- emmeans(cox_SKN_15_only, "Tr_temp")
N2_15_em2 <- emmeans(cox_N2_15_only, "Treatment.ID")
SKN_15_c1 <- contrast(SKN_15_em1, method = "revpairwise")  # or whatever method suits
N2_15_c2 <- contrast(N2_15_em2, method = "revpairwise")

#put contrasts into df and name
SKN_15_c1_df <- as.data.frame(SKN_15_c1)
SKN_15_c1_df$model <- "SKN-1"
N2_15_c2_df <- as.data.frame(N2_15_c2)
N2_15_c2_df$model <- "N2"

#calculate Cis
SKN_15_c1_df$lower.CL <- SKN_15_c1_df$estimate - 1.96 * SKN_15_c1_df$SE
SKN_15_c1_df$upper.CL <- SKN_15_c1_df$estimate + 1.96 * SKN_15_c1_df$SE
N2_15_c2_df$lower.CL <- N2_15_c2_df$estimate - 1.96 * N2_15_c2_df$SE
N2_15_c2_df$upper.CL <- N2_15_c2_df$estimate + 1.96 *N2_15_c2_df$SE

#combine dfs
all_15_df <- rbind(SKN_15_c1_df, N2_15_c2_df)

#remove contrast of daf-15F to daf-15
all_15_df <- all_15_df %>%
  filter(contrast != 'daf_15F - daf_15')

# Optional: create a combined label
all_15_df$label <- paste(all_15_df$model, all_15_df$contrast, sep = ": ")



#change contrast names
all_15_df$contrast <- fct_recode(all_15_df$contrast,
  "SKN-1: daf-2 - ev" = "daf_15 - ev_15",
  "SKN-1: daf-2 with cycle - ev" = "daf_15F - ev_15",
  "N2: daf-2 - ev" = "daf - ev")

levels(all_15_df$contrast)

#make labels for plot
all_15_df <- all_15_df %>%
  mutate(label = recode(label,
    "SKN-1: daf_15 - ev_15"  = "SKN-1: daf-2 - ev",
    "SKN-1: daf_15F - ev_15" = "SKN-1: daf-2 with cycle - ev",
    "N2: daf - ev"           = "N2: daf-2 - ev"
  ))

#Plot HRs for N2 and SKN-1 together
SKN_N2_15_HR <- ggplot(all_15_df, aes(x = estimate, y = label, color = contrast)) +
  geom_point(size = 4) +
  geom_errorbarh(aes(xmin = lower.CL, xmax = upper.CL), height = 0.2, linewidth = 1.1) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50", size = 1.1) +
  labs(x = "Log Hazard Ratio", y = "") +
  scale_color_manual(values = c('#4DBBD5FF', '#3C5488FF','#F39B7FFF'))+
  theme_minimal()+
    theme(legend.position = 'none',
         axis.text= element_text(size = 12),
         axis.title = element_text(size = 14))+
  guides(color = "none", fill = "none", shape = "none")
  
SKN_N2_15_HR

#Get EMMS - matricides censored
SKN_15NM_em1 <- emmeans(cox_SKN_15_only_NM, "Tr_temp")
N2_15NM_em2 <- emmeans(cox_N2_15_only_NM, "Treatment.ID")

#Get contrasts
SKN_15NM_c1 <- contrast(SKN_15NM_em1, method = "revpairwise")  # or whatever method suits
N2_15NM_c2 <- contrast(N2_15NM_em2, method = "revpairwise")

#Make contrasts into df and name
SKN_15NM_c1_df <- as.data.frame(SKN_15NM_c1)
SKN_15NM_c1_df$model <- "SKN-1"

#Make contrasts into df and name
N2_15NM_c2_df <- as.data.frame(N2_15NM_c2)
N2_15NM_c2_df$model <- "N2"

#calculate CI
SKN_15NM_c1_df$lower.CL <- SKN_15NM_c1_df$estimate - 1.96 * SKN_15NM_c1_df$SE
SKN_15NM_c1_df$upper.CL <- SKN_15NM_c1_df$estimate + 1.96 * SKN_15NM_c1_df$SE

#calculate CI
N2_15NM_c2_df$lower.CL <- N2_15NM_c2_df$estimate - 1.96 * N2_15NM_c2_df$SE
N2_15NM_c2_df$upper.CL <- N2_15NM_c2_df$estimate + 1.96 *N2_15NM_c2_df$SE

#combine datasets for SKN and N2 into one for plot
all_15NM_df <- rbind(SKN_15NM_c1_df, N2_15NM_c2_df)

#Exclude daf-15cycle and daf-15 contrast - want to know how it's different from controls
all_15NM_df <- all_15NM_df %>%
  filter(contrast != 'daf_15F - daf_15')

# create a combined label
all_15NM_df$label <- paste(all_15NM_df$model, all_15NM_df$contrast, sep = ": ")


#change contrast names
all_15NM_df$contrast <- fct_recode(all_15NM_df$contrast,
  "SKN-1: daf-2 - ev" = "daf_15 - ev_15",
  "SKN-1: daf-2 with cycle - ev" = "daf_15F - ev_15",
  "N2: daf-2 - ev" = "daf - ev")

levels(all_15NM_df$contrast)

#make them labels for plot
all_15NM_df <- all_15NM_df %>%
  mutate(label = recode(label,
    "SKN-1: daf_15 - ev_15"  = "SKN-1: daf-2 - ev",
    "SKN-1: daf_15F - ev_15" = "SKN-1: daf-2 with cycle - ev",
    "N2: daf - ev"           = "N2: daf-2 - ev"
  ))

#create plot combinding 
SKN_N2_15NM_HR <- ggplot(all_15NM_df, aes(x = estimate, y = label, color = contrast)) +
  geom_point(size = 4) +
  geom_errorbarh(aes(xmin = lower.CL, xmax = upper.CL), height = 0.2, linewidth = 1.1) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "grey50", size = 1.1) +
  labs(x = "Log Hazard Ratio", y = "") +
  scale_color_manual(values = c('#4DBBD5FF', '#3C5488FF','#F39B7FFF'))+
  theme_minimal()+
    theme(legend.position = 'none',
         axis.text= element_text(size = 12),
         axis.title = element_text(size = 14))+
  guides(color = "none", fill = "none", shape = "none")

SKN_N2_15NM_HR


SKN_15_25_all <- ggarrange(SKN_15_plot$plot+ theme(plot.title = element_text(face = "bold")), SKN_25_plot$plot+ theme(plot.title = element_text(face = "bold")), SKN_N2_15_HR,  SKN_N2_25_HR, nrow = 2, ncol = 2, common.legend = T, labels = c('A','B','C','D'))
SKN_15_25_all

ggsave("SKN_15_25_all.png", plot = SKN_15_25_all, bg = 'white',width = 12, height = 8, dpi = 300, units = "in")

SKN_15_25_NM_all <- ggarrange(SKN_15_NM_plot$plot+ theme(plot.title = element_text(face = "bold")), SKN_25_NM_plot$plot+ theme(plot.title = element_text(face = "bold")), SKN_N2_15NM_HR,  SKN_N2_25NM_HR+theme(plot.margin = margin(t = 5, r = 25, b = 5, l = 5, unit = "pt")), nrow = 2, ncol = 2, common.legend = T, labels = c('A','B','C','D'))
SKN_15_25_NM_all


ggsave("SKN_15_25_NM_all.png", plot = SKN_15_25_NM_all, bg = 'white',width = 12, height = 8, dpi = 300, units = "in")


```

